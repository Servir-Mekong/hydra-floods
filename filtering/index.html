
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.8">
    
    
      
        <title>filtering module - HYDRAFloods Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.644de097.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#hydrafloods.filtering" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="HYDRAFloods Documentation" class="md-header__button md-logo" aria-label="HYDRAFloods Documentation" data-md-component="logo">
      
  <img src="../img/hydrafloods_logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            HYDRAFloods Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              filtering module
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="HYDRAFloods Documentation" class="md-nav__button md-logo" aria-label="HYDRAFloods Documentation" data-md-component="logo">
      
  <img src="../img/hydrafloods_logo.png" alt="logo">

    </a>
    HYDRAFloods Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        Installation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../using-datasets/" class="md-nav__link">
        Using the Dataset class
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../algorithms/" class="md-nav__link">
        Algorithms
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../workflow-example/" class="md-nav__link">
        Workflow Example
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../cli/" class="md-nav__link">
        Command Line Interface
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_8">
          API Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="API Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          API Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../corrections/" class="md-nav__link">
        corrections module
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../datasets/" class="md-nav__link">
        datasets module
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../depths/" class="md-nav__link">
        depths module
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../decorators/" class="md-nav__link">
        decorators module
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../fetch/" class="md-nav__link">
        fetch module
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../floods/" class="md-nav__link">
        floods module
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          filtering module
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        filtering module
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#hydrafloods.filtering" class="md-nav__link">
    filtering
  </a>
  
    <nav class="md-nav" aria-label="filtering">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hydrafloods.filtering.close_binary" class="md-nav__link">
    close_binary()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hydrafloods.filtering.gamma_map" class="md-nav__link">
    gamma_map()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hydrafloods.filtering.lee_sigma" class="md-nav__link">
    lee_sigma()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hydrafloods.filtering.modified_median_zscore" class="md-nav__link">
    modified_median_zscore()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hydrafloods.filtering.open_binary" class="md-nav__link">
    open_binary()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hydrafloods.filtering.p_median" class="md-nav__link">
    p_median()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hydrafloods.filtering.perona_malik" class="md-nav__link">
    perona_malik()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hydrafloods.filtering.refined_lee" class="md-nav__link">
    refined_lee()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../fuzzy/" class="md-nav__link">
        fuzzy module
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../geeutils/" class="md-nav__link">
        geeutils module
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../indices/" class="md-nav__link">
        indices module
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ml/" class="md-nav__link">
        ml module
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../thresholding/" class="md-nav__link">
        thresholding module
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../timeseries/" class="md-nav__link">
        timeseries module
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../utils/" class="md-nav__link">
        utils module
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../dswfp/" class="md-nav__link">
        workflows.dswfp module
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#hydrafloods.filtering" class="md-nav__link">
    filtering
  </a>
  
    <nav class="md-nav" aria-label="filtering">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hydrafloods.filtering.close_binary" class="md-nav__link">
    close_binary()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hydrafloods.filtering.gamma_map" class="md-nav__link">
    gamma_map()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hydrafloods.filtering.lee_sigma" class="md-nav__link">
    lee_sigma()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hydrafloods.filtering.modified_median_zscore" class="md-nav__link">
    modified_median_zscore()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hydrafloods.filtering.open_binary" class="md-nav__link">
    open_binary()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hydrafloods.filtering.p_median" class="md-nav__link">
    p_median()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hydrafloods.filtering.perona_malik" class="md-nav__link">
    perona_malik()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hydrafloods.filtering.refined_lee" class="md-nav__link">
    refined_lee()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


  <h1>filtering module</h1>

<div class="doc doc-object doc-module">



<h2 class="doc doc-heading" id="hydrafloods.filtering">
        <code>hydrafloods.filtering</code>



</h2>

    <div class="doc doc-contents first">




  <div class="doc doc-children">








  <div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="hydrafloods.filtering.close_binary">
<code class="codehilite language-python"><span class="n">close_binary</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">neighborhood</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Closing morphological filter. Closing is the erosion of the dialiation of
values greater than 1.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>img</code></td>
        <td><code>ee.Image</code></td>
        <td><p>binary image to apply closing filter on</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>window</code></td>
        <td><code>int | ee.Number</code></td>
        <td><p>distance in pixels to consider for closing process</p></td>
        <td><code>3</code></td>
      </tr>
      <tr>
        <td><code>neighborhood</code></td>
        <td><code>int | ee.Number</code></td>
        <td><p>size of the neighborhood to perform fast
distance trasnform. Smaller values speed up operations however must be greater
than window. If no neighborhood is provided, it will be double the window size.
default = None</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>ee.Image</code></td>
      <td><p>the closed binary image</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>hydrafloods/filtering.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@decorators</span><span class="o">.</span><span class="n">keep_names</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">keep_attrs</span>
<span class="k">def</span> <span class="nf">close_binary</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">neighborhood</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Closing morphological filter. Closing is the erosion of the dialiation of</span>
<span class="sd">    values greater than 1.</span>

<span class="sd">    args:</span>
<span class="sd">        img (ee.Image): binary image to apply closing filter on</span>
<span class="sd">        window (int | ee.Number, optional): distance in pixels to consider for closing process</span>
<span class="sd">        neighborhood (int | ee.Number, optional): size of the neighborhood to perform fast</span>
<span class="sd">            distance trasnform. Smaller values speed up operations however must be greater</span>
<span class="sd">            than window. If no neighborhood is provided, it will be double the window size.</span>
<span class="sd">            default = None</span>

<span class="sd">    returns:</span>
<span class="sd">        ee.Image: the closed binary image</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">):</span>
        <span class="n">window</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">neighborhood</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">neighborhood</span> <span class="o">=</span> <span class="n">window</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">dialation</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">fastDistanceTransform</span><span class="p">(</span><span class="n">neighborhood</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
    <span class="n">closed</span> <span class="o">=</span> <span class="n">dialation</span><span class="o">.</span><span class="n">Not</span><span class="p">()</span><span class="o">.</span><span class="n">fastDistanceTransform</span><span class="p">(</span><span class="n">neighborhood</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">closed</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">mask</span><span class="p">())</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="hydrafloods.filtering.gamma_map">
<code class="codehilite language-python"><span class="n">gamma_map</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">enl</span><span class="o">=</span><span class="mf">4.9</span><span class="p">,</span> <span class="n">keep_bands</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">])</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Gamma Map speckle filtering algorithm.
Algorithm adapted from https://groups.google.com/g/google-earth-engine-developers/c/a9W0Nlrhoq0/m/tnGMC45jAgAJ.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>img</code></td>
        <td><code>ee.Image</code></td>
        <td><p>Earth engine image object. Expects that imagery is a SAR image</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>window</code></td>
        <td><code>int</code></td>
        <td><p>moving window size to apply filter (i.e. a value of 7 == 7x7 window). default = 7</p></td>
        <td><code>7</code></td>
      </tr>
      <tr>
        <td><code>enl</code></td>
        <td><code>float</code></td>
        <td><p>equivalent number of looks (enl) per pixel from a SAR scan.
See https://sentinel.esa.int/web/sentinel/user-guides/sentinel-1-sar/resolutions/level-1-ground-range-detected.
default = 4.9</p></td>
        <td><code>4.9</code></td>
      </tr>
      <tr>
        <td><code>keep_bands</code></td>
        <td><code>list[str]</code></td>
        <td><p>list of band names to drop during filtering and include in the result
default = ["angle"]</p></td>
        <td><code>[&#39;angle&#39;]</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>ee.Image</code></td>
      <td><p>filtered SAR image using the Gamma Map algorithm</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>hydrafloods/filtering.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@decorators</span><span class="o">.</span><span class="n">keep_names</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">keep_attrs</span>
<span class="k">def</span> <span class="nf">gamma_map</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">enl</span><span class="o">=</span><span class="mf">4.9</span><span class="p">,</span> <span class="n">keep_bands</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Gamma Map speckle filtering algorithm.</span>
<span class="sd">    Algorithm adapted from https://groups.google.com/g/google-earth-engine-developers/c/a9W0Nlrhoq0/m/tnGMC45jAgAJ.</span>

<span class="sd">    args:</span>
<span class="sd">        img (ee.Image): Earth engine image object. Expects that imagery is a SAR image</span>
<span class="sd">        window (int, optional): moving window size to apply filter (i.e. a value of 7 == 7x7 window). default = 7</span>
<span class="sd">        enl (float, optional): equivalent number of looks (enl) per pixel from a SAR scan.</span>
<span class="sd">            See https://sentinel.esa.int/web/sentinel/user-guides/sentinel-1-sar/resolutions/level-1-ground-range-detected.</span>
<span class="sd">            default = 4.9</span>
<span class="sd">        keep_bands (list[str], optional): list of band names to drop during filtering and include in the result</span>
<span class="sd">            default = [&quot;angle&quot;]</span>

<span class="sd">    returns:</span>
<span class="sd">        ee.Image: filtered SAR image using the Gamma Map algorithm</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">band_names</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">keep_bands</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">keep_img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">keep_bands</span><span class="p">)</span>
        <span class="n">proc_bands</span> <span class="o">=</span> <span class="n">band_names</span><span class="o">.</span><span class="n">removeAll</span><span class="p">(</span><span class="n">keep_bands</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">proc_bands</span> <span class="o">=</span> <span class="n">band_names</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">proc_bands</span><span class="p">)</span>

    <span class="c1"># Square kernel, window should be odd (typically 3, 5 or 7)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">window</span><span class="p">),</span> <span class="n">window</span><span class="p">)</span>
    <span class="n">midPt</span> <span class="o">=</span> <span class="p">(</span><span class="n">window</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="p">(</span><span class="n">window</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">window</span> <span class="o">//</span> <span class="mi">2</span>

    <span class="c1"># ~~(window/2) does integer division in JavaScript</span>
    <span class="n">kernel</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Kernel</span><span class="o">.</span><span class="n">fixed</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">midPt</span><span class="p">,</span> <span class="n">midPt</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Convert image from dB to natural values</span>
    <span class="n">nat_img</span> <span class="o">=</span> <span class="n">geeutils</span><span class="o">.</span><span class="n">db_to_power</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

    <span class="c1"># Get mean and variance</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">nat_img</span><span class="o">.</span><span class="n">reduceNeighborhood</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">kernel</span><span class="p">)</span>
    <span class="n">variance</span> <span class="o">=</span> <span class="n">nat_img</span><span class="o">.</span><span class="n">reduceNeighborhood</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">variance</span><span class="p">(),</span> <span class="n">kernel</span><span class="p">)</span>

    <span class="c1"># &quot;Pure speckle&quot; threshold</span>
    <span class="n">ci</span> <span class="o">=</span> <span class="n">variance</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span>  <span class="c1"># square root of inverse of enl</span>

    <span class="c1"># If ci &lt;= cu, the kernel lies in a &quot;pure speckle&quot; area -&gt; return simple mean</span>
    <span class="n">cu</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">enl</span><span class="p">)</span>

    <span class="c1"># If cu &lt; ci &lt; cmax the kernel lies in the low textured speckle area -&gt; return the filtered value</span>
    <span class="n">cmax</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">cu</span>

    <span class="n">alpha</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">cu</span> <span class="o">*</span> <span class="n">cu</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">ci</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">ci</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">cu</span> <span class="o">*</span> <span class="n">cu</span><span class="p">))</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">enl</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">mean</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span>
        <span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">alpha</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">nat_img</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">enl</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">sqrt</span><span class="p">())</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">alpha</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mf">2.0</span><span class="p">))</span>

    <span class="n">caster</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="o">.</span><span class="n">fromLists</span><span class="p">(</span>
        <span class="n">proc_bands</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="n">proc_bands</span><span class="o">.</span><span class="n">length</span><span class="p">())</span>
    <span class="p">)</span>
    <span class="n">img1</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">geeutils</span><span class="o">.</span><span class="n">power_to_db</span><span class="p">(</span><span class="n">mean</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">ci</span><span class="o">.</span><span class="n">lte</span><span class="p">(</span><span class="n">cu</span><span class="p">)))</span>
        <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">proc_bands</span><span class="p">)</span>
        <span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">caster</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">img2</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">geeutils</span><span class="o">.</span><span class="n">power_to_db</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">ci</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">cu</span><span class="p">))</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">ci</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">cmax</span><span class="p">)))</span>
        <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">proc_bands</span><span class="p">)</span>
        <span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">caster</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">img3</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">ci</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="n">cmax</span><span class="p">))</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">proc_bands</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">caster</span><span class="p">)</span>

    <span class="c1"># If ci &gt; cmax do not filter at all (i.e. we don&#39;t do anything, other then masking)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">([</span><span class="n">img1</span><span class="p">,</span> <span class="n">img2</span><span class="p">,</span> <span class="n">img3</span><span class="p">])</span>
        <span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">firstNonNull</span><span class="p">())</span>
        <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">proc_bands</span><span class="p">)</span>
        <span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">geometry</span><span class="p">())</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">keep_bands</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">keep_img</span><span class="p">)</span>

    <span class="c1"># Compose a 3 band image with the mean filtered &quot;pure speckle&quot;, the &quot;low textured&quot; filtered and the unfiltered portions</span>
    <span class="k">return</span> <span class="n">output</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="hydrafloods.filtering.lee_sigma">
<code class="codehilite language-python"><span class="n">lee_sigma</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">looks</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">tk</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">keep_bands</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">])</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Lee Sigma speckle filtering algorithm.
Implemented from interpreting https://doi.org/10.1109/TGRS.2008.2002881</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>img</code></td>
        <td><code>ee.Image</code></td>
        <td><p>Earth engine image object. Expects that imagery is a SAR image</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>window</code></td>
        <td><code>int</code></td>
        <td><p>moving window size to apply filter (i.e. a value of 9 == 9x9 window). default = 9</p></td>
        <td><code>9</code></td>
      </tr>
      <tr>
        <td><code>sigma</code></td>
        <td><code>float</code></td>
        <td><p>sigma lookup value from table 1 in paper. default = 0.9</p></td>
        <td><code>0.9</code></td>
      </tr>
      <tr>
        <td><code>looks</code></td>
        <td><code>int</code></td>
        <td><p>look intensity value from table 1 in paper. default = 4</p></td>
        <td><code>4</code></td>
      </tr>
      <tr>
        <td><code>tk</code></td>
        <td><code>int</code></td>
        <td><p>threshold value to determine values in window as point targets. default = 7</p></td>
        <td><code>7</code></td>
      </tr>
      <tr>
        <td><code>keep_bands</code></td>
        <td><code>list[str]</code></td>
        <td><p>list of band names to drop during filtering and include in the result
default = ["angle"]</p></td>
        <td><code>[&#39;angle&#39;]</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>ee.Image</code></td>
      <td><p>filtered SAR image using the Lee Sigma algorithm</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>hydrafloods/filtering.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@decorators</span><span class="o">.</span><span class="n">keep_names</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">keep_attrs</span>
<span class="k">def</span> <span class="nf">lee_sigma</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">looks</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">tk</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">keep_bands</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Lee Sigma speckle filtering algorithm.</span>
<span class="sd">    Implemented from interpreting https://doi.org/10.1109/TGRS.2008.2002881</span>

<span class="sd">    args:</span>
<span class="sd">        img (ee.Image): Earth engine image object. Expects that imagery is a SAR image</span>
<span class="sd">        window (int, optional): moving window size to apply filter (i.e. a value of 9 == 9x9 window). default = 9</span>
<span class="sd">        sigma (float, optional): sigma lookup value from table 1 in paper. default = 0.9</span>
<span class="sd">        looks (int, optional): look intensity value from table 1 in paper. default = 4</span>
<span class="sd">        tk (int, optional): threshold value to determine values in window as point targets. default = 7</span>
<span class="sd">        keep_bands (list[str], optional): list of band names to drop during filtering and include in the result</span>
<span class="sd">            default = [&quot;angle&quot;]</span>

<span class="sd">    returns:</span>
<span class="sd">        ee.Image: filtered SAR image using the Lee Sigma algorithm</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">band_names</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">keep_bands</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">keep_img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">keep_bands</span><span class="p">)</span>
        <span class="n">proc_bands</span> <span class="o">=</span> <span class="n">band_names</span><span class="o">.</span><span class="n">removeAll</span><span class="p">(</span><span class="n">keep_bands</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">proc_bands</span> <span class="o">=</span> <span class="n">band_names</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">proc_bands</span><span class="p">)</span>

    <span class="n">midPt</span> <span class="o">=</span> <span class="p">(</span><span class="n">window</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="p">(</span><span class="n">window</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">window</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">kernelWeights</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">window</span><span class="p">),</span> <span class="n">window</span><span class="p">)</span>
    <span class="n">kernel</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Kernel</span><span class="o">.</span><span class="n">fixed</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">kernelWeights</span><span class="p">,</span> <span class="n">midPt</span><span class="p">,</span> <span class="n">midPt</span><span class="p">)</span>

    <span class="n">targetWeights</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">targetkernel</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Kernel</span><span class="o">.</span><span class="n">fixed</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">targetWeights</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Lookup table for range and eta values for intensity</span>
    <span class="n">sigmaLookup</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="mi">1</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="mf">0.5</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">({</span><span class="s2">&quot;A1&quot;</span><span class="p">:</span> <span class="mf">0.436</span><span class="p">,</span> <span class="s2">&quot;A2&quot;</span><span class="p">:</span> <span class="mf">1.92</span><span class="p">,</span> <span class="s2">&quot;η&quot;</span><span class="p">:</span> <span class="mf">0.4057</span><span class="p">}),</span>
                    <span class="mf">0.6</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">({</span><span class="s2">&quot;A1&quot;</span><span class="p">:</span> <span class="mf">0.343</span><span class="p">,</span> <span class="s2">&quot;A2&quot;</span><span class="p">:</span> <span class="mf">2.21</span><span class="p">,</span> <span class="s2">&quot;η&quot;</span><span class="p">:</span> <span class="mf">0.4954</span><span class="p">}),</span>
                    <span class="mf">0.7</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">({</span><span class="s2">&quot;A1&quot;</span><span class="p">:</span> <span class="mf">0.254</span><span class="p">,</span> <span class="s2">&quot;A2&quot;</span><span class="p">:</span> <span class="mf">2.582</span><span class="p">,</span> <span class="s2">&quot;η&quot;</span><span class="p">:</span> <span class="mf">0.5911</span><span class="p">}),</span>
                    <span class="mf">0.8</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">({</span><span class="s2">&quot;A1&quot;</span><span class="p">:</span> <span class="mf">0.168</span><span class="p">,</span> <span class="s2">&quot;A2&quot;</span><span class="p">:</span> <span class="mf">3.094</span><span class="p">,</span> <span class="s2">&quot;η&quot;</span><span class="p">:</span> <span class="mf">0.6966</span><span class="p">}),</span>
                    <span class="mf">0.9</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">({</span><span class="s2">&quot;A1&quot;</span><span class="p">:</span> <span class="mf">0.084</span><span class="p">,</span> <span class="s2">&quot;A2&quot;</span><span class="p">:</span> <span class="mf">3.941</span><span class="p">,</span> <span class="s2">&quot;η&quot;</span><span class="p">:</span> <span class="mf">0.8191</span><span class="p">}),</span>
                    <span class="mf">0.95</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">({</span><span class="s2">&quot;A1&quot;</span><span class="p">:</span> <span class="mf">0.043</span><span class="p">,</span> <span class="s2">&quot;A2&quot;</span><span class="p">:</span> <span class="mf">4.840</span><span class="p">,</span> <span class="s2">&quot;η&quot;</span><span class="p">:</span> <span class="mf">0.8599</span><span class="p">}),</span>
                <span class="p">}</span>
            <span class="p">),</span>
            <span class="mi">2</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="mf">0.5</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">({</span><span class="s2">&quot;A1&quot;</span><span class="p">:</span> <span class="mf">0.582</span><span class="p">,</span> <span class="s2">&quot;A2&quot;</span><span class="p">:</span> <span class="mf">1.584</span><span class="p">,</span> <span class="s2">&quot;η&quot;</span><span class="p">:</span> <span class="mf">0.2763</span><span class="p">}),</span>
                    <span class="mf">0.6</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">({</span><span class="s2">&quot;A1&quot;</span><span class="p">:</span> <span class="mf">0.501</span><span class="p">,</span> <span class="s2">&quot;A2&quot;</span><span class="p">:</span> <span class="mf">1.755</span><span class="p">,</span> <span class="s2">&quot;η&quot;</span><span class="p">:</span> <span class="mf">0.3388</span><span class="p">}),</span>
                    <span class="mf">0.7</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">({</span><span class="s2">&quot;A1&quot;</span><span class="p">:</span> <span class="mf">0.418</span><span class="p">,</span> <span class="s2">&quot;A2&quot;</span><span class="p">:</span> <span class="mf">1.972</span><span class="p">,</span> <span class="s2">&quot;η&quot;</span><span class="p">:</span> <span class="mf">0.4062</span><span class="p">}),</span>
                    <span class="mf">0.8</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">({</span><span class="s2">&quot;A1&quot;</span><span class="p">:</span> <span class="mf">0.327</span><span class="p">,</span> <span class="s2">&quot;A2&quot;</span><span class="p">:</span> <span class="mf">2.260</span><span class="p">,</span> <span class="s2">&quot;η&quot;</span><span class="p">:</span> <span class="mf">0.4819</span><span class="p">}),</span>
                    <span class="mf">0.9</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">({</span><span class="s2">&quot;A1&quot;</span><span class="p">:</span> <span class="mf">0.221</span><span class="p">,</span> <span class="s2">&quot;A2&quot;</span><span class="p">:</span> <span class="mf">2.744</span><span class="p">,</span> <span class="s2">&quot;η&quot;</span><span class="p">:</span> <span class="mf">0.5699</span><span class="p">}),</span>
                    <span class="mf">0.95</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">({</span><span class="s2">&quot;A1&quot;</span><span class="p">:</span> <span class="mf">0.152</span><span class="p">,</span> <span class="s2">&quot;A2&quot;</span><span class="p">:</span> <span class="mf">3.206</span><span class="p">,</span> <span class="s2">&quot;η&quot;</span><span class="p">:</span> <span class="mf">0.6254</span><span class="p">}),</span>
                <span class="p">}</span>
            <span class="p">),</span>
            <span class="mi">3</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="mf">0.5</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">({</span><span class="s2">&quot;A1&quot;</span><span class="p">:</span> <span class="mf">0.652</span><span class="p">,</span> <span class="s2">&quot;A2&quot;</span><span class="p">:</span> <span class="mf">1.458</span><span class="p">,</span> <span class="s2">&quot;η&quot;</span><span class="p">:</span> <span class="mf">0.2222</span><span class="p">}),</span>
                    <span class="mf">0.6</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">({</span><span class="s2">&quot;A1&quot;</span><span class="p">:</span> <span class="mf">0.580</span><span class="p">,</span> <span class="s2">&quot;A2&quot;</span><span class="p">:</span> <span class="mf">1.586</span><span class="p">,</span> <span class="s2">&quot;η&quot;</span><span class="p">:</span> <span class="mf">0.2736</span><span class="p">}),</span>
                    <span class="mf">0.7</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">({</span><span class="s2">&quot;A1&quot;</span><span class="p">:</span> <span class="mf">0.505</span><span class="p">,</span> <span class="s2">&quot;A2&quot;</span><span class="p">:</span> <span class="mf">1.751</span><span class="p">,</span> <span class="s2">&quot;η&quot;</span><span class="p">:</span> <span class="mf">0.3280</span><span class="p">}),</span>
                    <span class="mf">0.8</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">({</span><span class="s2">&quot;A1&quot;</span><span class="p">:</span> <span class="mf">0.419</span><span class="p">,</span> <span class="s2">&quot;A2&quot;</span><span class="p">:</span> <span class="mf">1.865</span><span class="p">,</span> <span class="s2">&quot;η&quot;</span><span class="p">:</span> <span class="mf">0.3892</span><span class="p">}),</span>
                    <span class="mf">0.9</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">({</span><span class="s2">&quot;A1&quot;</span><span class="p">:</span> <span class="mf">0.313</span><span class="p">,</span> <span class="s2">&quot;A2&quot;</span><span class="p">:</span> <span class="mf">2.320</span><span class="p">,</span> <span class="s2">&quot;η&quot;</span><span class="p">:</span> <span class="mf">0.4624</span><span class="p">}),</span>
                    <span class="mf">0.95</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">({</span><span class="s2">&quot;A1&quot;</span><span class="p">:</span> <span class="mf">0.238</span><span class="p">,</span> <span class="s2">&quot;A2&quot;</span><span class="p">:</span> <span class="mf">2.656</span><span class="p">,</span> <span class="s2">&quot;η&quot;</span><span class="p">:</span> <span class="mf">0.5084</span><span class="p">}),</span>
                <span class="p">}</span>
            <span class="p">),</span>
            <span class="mi">4</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="mf">0.5</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">({</span><span class="s2">&quot;A1&quot;</span><span class="p">:</span> <span class="mf">0.694</span><span class="p">,</span> <span class="s2">&quot;A2&quot;</span><span class="p">:</span> <span class="mf">1.385</span><span class="p">,</span> <span class="s2">&quot;η&quot;</span><span class="p">:</span> <span class="mf">0.1921</span><span class="p">}),</span>
                    <span class="mf">0.6</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">({</span><span class="s2">&quot;A1&quot;</span><span class="p">:</span> <span class="mf">0.630</span><span class="p">,</span> <span class="s2">&quot;A2&quot;</span><span class="p">:</span> <span class="mf">1.495</span><span class="p">,</span> <span class="s2">&quot;η&quot;</span><span class="p">:</span> <span class="mf">0.2348</span><span class="p">}),</span>
                    <span class="mf">0.7</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">({</span><span class="s2">&quot;A1&quot;</span><span class="p">:</span> <span class="mf">0.560</span><span class="p">,</span> <span class="s2">&quot;A2&quot;</span><span class="p">:</span> <span class="mf">1.627</span><span class="p">,</span> <span class="s2">&quot;η&quot;</span><span class="p">:</span> <span class="mf">0.2825</span><span class="p">}),</span>
                    <span class="mf">0.8</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">({</span><span class="s2">&quot;A1&quot;</span><span class="p">:</span> <span class="mf">0.480</span><span class="p">,</span> <span class="s2">&quot;A2&quot;</span><span class="p">:</span> <span class="mf">1.804</span><span class="p">,</span> <span class="s2">&quot;η&quot;</span><span class="p">:</span> <span class="mf">0.3354</span><span class="p">}),</span>
                    <span class="mf">0.9</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">({</span><span class="s2">&quot;A1&quot;</span><span class="p">:</span> <span class="mf">0.378</span><span class="p">,</span> <span class="s2">&quot;A2&quot;</span><span class="p">:</span> <span class="mf">2.094</span><span class="p">,</span> <span class="s2">&quot;η&quot;</span><span class="p">:</span> <span class="mf">0.3991</span><span class="p">}),</span>
                    <span class="mf">0.95</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">({</span><span class="s2">&quot;A1&quot;</span><span class="p">:</span> <span class="mf">0.302</span><span class="p">,</span> <span class="s2">&quot;A2&quot;</span><span class="p">:</span> <span class="mf">2.360</span><span class="p">,</span> <span class="s2">&quot;η&quot;</span><span class="p">:</span> <span class="mf">0.4391</span><span class="p">}),</span>
                <span class="p">}</span>
            <span class="p">),</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="c1"># extract data from lookup</span>
    <span class="n">looksDict</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span><span class="n">sigmaLookup</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">looks</span><span class="p">))))</span>
    <span class="n">sigmaImage</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span><span class="n">looksDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sigma</span><span class="p">))))</span><span class="o">.</span><span class="n">toImage</span><span class="p">()</span>
    <span class="n">a1</span> <span class="o">=</span> <span class="n">sigmaImage</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;A1&quot;</span><span class="p">)</span>
    <span class="n">a2</span> <span class="o">=</span> <span class="n">sigmaImage</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;A2&quot;</span><span class="p">)</span>
    <span class="n">aRange</span> <span class="o">=</span> <span class="n">a2</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
    <span class="n">eta</span> <span class="o">=</span> <span class="n">sigmaImage</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;η&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">geeutils</span><span class="o">.</span><span class="n">db_to_power</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

    <span class="c1"># MMSE estimator</span>
    <span class="n">mmseMask</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span><span class="o">.</span><span class="n">Or</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">lte</span><span class="p">(</span><span class="n">a2</span><span class="p">))</span>
    <span class="n">mmseIn</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">mmseMask</span><span class="p">)</span>
    <span class="n">oneImg</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">mmseIn</span><span class="o">.</span><span class="n">reduceNeighborhood</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">kernel</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">varz</span> <span class="o">=</span> <span class="n">mmseIn</span><span class="o">.</span><span class="n">reduceNeighborhood</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">variance</span><span class="p">(),</span> <span class="n">kernel</span><span class="p">)</span>
    <span class="n">varx</span> <span class="o">=</span> <span class="p">(</span><span class="n">varz</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">eta</span><span class="p">)))</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">oneImg</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">eta</span><span class="p">))</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">varx</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">varz</span><span class="p">)</span>
    <span class="n">mmse</span> <span class="o">=</span> <span class="n">oneImg</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">abs</span><span class="p">())</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">mmseIn</span><span class="p">))</span>

    <span class="c1"># workflow</span>
    <span class="n">z99</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span>
        <span class="n">img</span><span class="o">.</span><span class="n">reduceRegion</span><span class="p">(</span>
            <span class="n">reducer</span><span class="o">=</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">percentile</span><span class="p">([</span><span class="mi">99</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">1e6</span><span class="p">),</span>
            <span class="n">geometry</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">geometry</span><span class="p">(),</span>
            <span class="n">scale</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">bestEffort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">toImage</span><span class="p">()</span>

    <span class="n">overThresh</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="n">z99</span><span class="p">)</span>

    <span class="n">K</span> <span class="o">=</span> <span class="n">overThresh</span><span class="o">.</span><span class="n">reduceNeighborhood</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">targetkernel</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">retainPixel</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="n">tk</span><span class="p">)</span>
    <span class="n">xHat</span> <span class="o">=</span> <span class="n">geeutils</span><span class="o">.</span><span class="n">power_to_db</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">retainPixel</span><span class="p">)</span><span class="o">.</span><span class="n">unmask</span><span class="p">(</span><span class="n">mmse</span><span class="p">))</span>

    <span class="n">output</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">xHat</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">proc_bands</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">keep_bands</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">keep_img</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="hydrafloods.filtering.modified_median_zscore">
<code class="codehilite language-python"><span class="n">modified_median_zscore</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">fill_img</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Outlier detection and filling on complete DEM using the modified z-score and a median filter
Method from  Iglewicz, B. and Hoaglin, D.C., 1993. How to detect and handle outliers (Vol. 16). Asq Press.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>img</code></td>
        <td><code>ee.Image</code></td>
        <td><p>Earth engine image object to apply filter on</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>fill_img</code></td>
        <td><code>ee.Image</code></td>
        <td><p>Earth engine image object to fill values resulting from filter.
If None provided, the fill operation will be on the input image. Default = None</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>ee.Image</code></td>
      <td><p>filtered image</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>hydrafloods/filtering.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@decorators</span><span class="o">.</span><span class="n">keep_names</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">keep_attrs</span>
<span class="k">def</span> <span class="nf">modified_median_zscore</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">fill_img</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Outlier detection and filling on complete DEM using the modified z-score and a median filter</span>
<span class="sd">    Method from  Iglewicz, B. and Hoaglin, D.C., 1993. How to detect and handle outliers (Vol. 16). Asq Press.</span>

<span class="sd">    args:</span>
<span class="sd">        img (ee.Image): Earth engine image object to apply filter on</span>
<span class="sd">        fill_img (ee.Image): Earth engine image object to fill values resulting from filter.</span>
<span class="sd">            If None provided, the fill operation will be on the input image. Default = None</span>

<span class="sd">    returns:</span>
<span class="sd">        ee.Image: filtered image</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">kernel</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Kernel</span><span class="o">.</span><span class="n">fixed</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
    <span class="n">kernel_weighted</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Kernel</span><span class="o">.</span><span class="n">fixed</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>

    <span class="n">median</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">focal_median</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">)</span>
    <span class="n">median_weighted</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">focal_median</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="n">kernel_weighted</span><span class="p">)</span>

    <span class="n">diff</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">median</span><span class="p">)</span>

    <span class="n">mzscore</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mf">0.6745</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">focal_median</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">fill_img</span><span class="p">:</span>
        <span class="n">filled</span> <span class="o">=</span> <span class="n">fill_img</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mzscore</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="mf">3.5</span><span class="p">),</span> <span class="n">median_weighted</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filled</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mzscore</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="mf">3.5</span><span class="p">),</span> <span class="n">median_weighted</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">filled</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="hydrafloods.filtering.open_binary">
<code class="codehilite language-python"><span class="n">open_binary</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">neighborhood</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Opening morphological filter. Opening is the dilation of the erosion of
values greater than 1.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>img</code></td>
        <td><code>ee.Image</code></td>
        <td><p>binary image to apply opening filter on</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>window</code></td>
        <td><code>int | ee.Number</code></td>
        <td><p>distance in pixels to consider for opening process</p></td>
        <td><code>3</code></td>
      </tr>
      <tr>
        <td><code>neighborhood</code></td>
        <td><code>int | ee.Number</code></td>
        <td><p>size of the neighborhood to perform fast
distance trasnform. Smaller values speed up operations however must be greater
than window. If no nerighborhood is provided, it will be double the window size.
default = None</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>ee.Image</code></td>
      <td><p>the opened binary image</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>hydrafloods/filtering.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@decorators</span><span class="o">.</span><span class="n">keep_names</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">keep_attrs</span>
<span class="k">def</span> <span class="nf">open_binary</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">neighborhood</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Opening morphological filter. Opening is the dilation of the erosion of</span>
<span class="sd">    values greater than 1.</span>

<span class="sd">    args:</span>
<span class="sd">        img (ee.Image): binary image to apply opening filter on</span>
<span class="sd">        window (int | ee.Number, optional): distance in pixels to consider for opening process</span>
<span class="sd">        neighborhood (int | ee.Number, optional): size of the neighborhood to perform fast</span>
<span class="sd">            distance trasnform. Smaller values speed up operations however must be greater</span>
<span class="sd">            than window. If no nerighborhood is provided, it will be double the window size.</span>
<span class="sd">            default = None</span>

<span class="sd">    returns:</span>
<span class="sd">        ee.Image: the opened binary image</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">):</span>
        <span class="n">window</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">neighborhood</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">neighborhood</span> <span class="o">=</span> <span class="n">window</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">erosion</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">Not</span><span class="p">()</span><span class="o">.</span><span class="n">fastDistanceTransform</span><span class="p">(</span><span class="n">neighborhood</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
    <span class="n">opened</span> <span class="o">=</span> <span class="n">erosion</span><span class="o">.</span><span class="n">fastDistanceTransform</span><span class="p">(</span><span class="n">neighborhood</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">opened</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">mask</span><span class="p">())</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="hydrafloods.filtering.p_median">
<code class="codehilite language-python"><span class="n">p_median</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">keep_bands</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">])</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>P-Median filter for smoothing imagery.
Calculates the average from the median along cross and diagnal pixels of a window</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>img</code></td>
        <td><code>ee.Image</code></td>
        <td><p>Earth engine image object to filter</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>window</code></td>
        <td><code>int</code></td>
        <td><p>moving window size to apply filter (i.e. a value of 5 == 5x5 window). default = 5</p></td>
        <td><code>5</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>ee.Image</code></td>
      <td><p>filtered image</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>hydrafloods/filtering.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@decorators</span><span class="o">.</span><span class="n">keep_names</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">keep_attrs</span>
<span class="k">def</span> <span class="nf">p_median</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">keep_bands</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;P-Median filter for smoothing imagery.</span>
<span class="sd">    Calculates the average from the median along cross and diagnal pixels of a window</span>

<span class="sd">    args:</span>
<span class="sd">        img (ee.Image): Earth engine image object to filter</span>
<span class="sd">        window (int, optional): moving window size to apply filter (i.e. a value of 5 == 5x5 window). default = 5</span>

<span class="sd">    returns:</span>
<span class="sd">        ee.Image: filtered image</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_band_filter</span><span class="p">(</span><span class="n">bname</span><span class="p">):</span>
        <span class="n">selector</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">([</span><span class="n">bname</span><span class="p">])</span>
        <span class="n">band_img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">selector</span><span class="p">)</span>
        <span class="n">hv_median</span> <span class="o">=</span> <span class="n">band_img</span><span class="o">.</span><span class="n">reduceNeighborhood</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span> <span class="n">hv_kernel</span><span class="p">)</span>
        <span class="n">diag_median</span> <span class="o">=</span> <span class="n">band_img</span><span class="o">.</span><span class="n">reduceNeighborhood</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span> <span class="n">diag_kernel</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">hv_median</span><span class="p">,</span> <span class="n">diag_median</span><span class="p">])</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">selector</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">window</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">window</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">center_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">window</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

    <span class="n">hv</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">center_idx</span> <span class="ow">or</span> <span class="n">j</span> <span class="o">==</span> <span class="n">center_idx</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">window</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">diag</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="p">((</span><span class="n">window</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">window</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># method based on ???</span>
    <span class="n">band_names</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span>
    <span class="n">hv_weights</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">hv</span><span class="p">)</span>
    <span class="n">diag_weights</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">diag</span><span class="p">)</span>

    <span class="n">hv_kernel</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Kernel</span><span class="o">.</span><span class="n">fixed</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">hv_weights</span><span class="p">)</span>
    <span class="n">diag_kernel</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Kernel</span><span class="o">.</span><span class="n">fixed</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">diag_weights</span><span class="p">)</span>

    <span class="n">reduced_bands</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="o">.</span><span class="n">fromImages</span><span class="p">(</span>
        <span class="n">band_names</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_band_filter</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">toBands</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">reduced_bands</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">band_names</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="hydrafloods.filtering.perona_malik">
<code class="codehilite language-python"><span class="n">perona_malik</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">n_iters</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Perona-Malik (anisotropic diffusion) convolution
Developed by Gennadii Donchyts see https://groups.google.com/g/google-earth-engine-developers/c/umGlt5qIN1I/m/PD8lsJ7qBAAJ
I(n+1, i, j) = I(n, i, j) + lambda * (cN * dN(I) + cS * dS(I) + cE * dE(I), cW * dW(I))</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>img</code></td>
        <td><code>ee.Image</code></td>
        <td><p>Earth engine image object. Expects that imagery is a SAR image</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>n_iters</code></td>
        <td><code>int</code></td>
        <td><p>Number of interations to apply filter
K (int,optional): moving window size to apply filter (i.e. a value of 7 == 7x7 window). default = 3</p></td>
        <td><code>10</code></td>
      </tr>
      <tr>
        <td><code>method</code></td>
        <td><code>int</code></td>
        <td><p>choose method 1 (default) or 2</p></td>
        <td><code>1</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>ee.Image</code></td>
      <td><p>filtered SAR image using the perona malik algorithm</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>hydrafloods/filtering.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@decorators</span><span class="o">.</span><span class="n">keep_names</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">keep_attrs</span>
<span class="k">def</span> <span class="nf">perona_malik</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">n_iters</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Perona-Malik (anisotropic diffusion) convolution</span>
<span class="sd">    Developed by Gennadii Donchyts see https://groups.google.com/g/google-earth-engine-developers/c/umGlt5qIN1I/m/PD8lsJ7qBAAJ</span>
<span class="sd">    I(n+1, i, j) = I(n, i, j) + lambda * (cN * dN(I) + cS * dS(I) + cE * dE(I), cW * dW(I))</span>

<span class="sd">    args:</span>
<span class="sd">        img (ee.Image): Earth engine image object. Expects that imagery is a SAR image</span>
<span class="sd">        n_iters (int, optional): Number of interations to apply filter</span>
<span class="sd">            K (int,optional): moving window size to apply filter (i.e. a value of 7 == 7x7 window). default = 3</span>
<span class="sd">        method (int, optional): choose method 1 (default) or 2</span>
<span class="sd">    returns:</span>
<span class="sd">        ee.Image: filtered SAR image using the perona malik algorithm</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_method_1</span><span class="p">(</span><span class="n">dI_W</span><span class="p">,</span> <span class="n">dI_E</span><span class="p">,</span> <span class="n">dI_N</span><span class="p">,</span> <span class="n">dI_S</span><span class="p">):</span>
        <span class="n">cW</span> <span class="o">=</span> <span class="n">dI_W</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span>
        <span class="n">cE</span> <span class="o">=</span> <span class="n">dI_E</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span>
        <span class="n">cN</span> <span class="o">=</span> <span class="n">dI_N</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span>
        <span class="n">cS</span> <span class="o">=</span> <span class="n">dI_S</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">cW</span><span class="p">,</span> <span class="n">cE</span><span class="p">,</span> <span class="n">cN</span><span class="p">,</span> <span class="n">cS</span>

    <span class="k">def</span> <span class="nf">_method_2</span><span class="p">(</span><span class="n">dI_W</span><span class="p">,</span> <span class="n">dI_E</span><span class="p">,</span> <span class="n">dI_N</span><span class="p">,</span> <span class="n">dI_S</span><span class="p">):</span>
        <span class="n">cW</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">one</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dI_W</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">k2</span><span class="p">)))</span>
        <span class="n">cE</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">one</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dI_E</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">k2</span><span class="p">)))</span>
        <span class="n">cN</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">one</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dI_N</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">k2</span><span class="p">)))</span>
        <span class="n">cS</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">one</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dI_S</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">k2</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">cW</span><span class="p">,</span> <span class="n">cE</span><span class="p">,</span> <span class="n">cN</span><span class="p">,</span> <span class="n">cS</span>

    <span class="c1"># covnert db to natural units  before applying filter</span>
    <span class="n">power</span> <span class="o">=</span> <span class="n">geeutils</span><span class="o">.</span><span class="n">db_to_power</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

    <span class="n">dxW</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Kernel</span><span class="o">.</span><span class="n">fixed</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
    <span class="n">dxE</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Kernel</span><span class="o">.</span><span class="n">fixed</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
    <span class="n">dyN</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Kernel</span><span class="o">.</span><span class="n">fixed</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
    <span class="n">dyS</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Kernel</span><span class="o">.</span><span class="n">fixed</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>

    <span class="n">one</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
    <span class="n">k1</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">K</span><span class="p">)</span>
    <span class="n">k2</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">_method</span> <span class="o">=</span> <span class="n">_method_1</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">_method</span> <span class="o">=</span> <span class="n">_method_2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;Could not determine algorithm to apply filter...options for `method` are 1 or 2&quot;</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_iters</span><span class="p">):</span>
        <span class="n">dI_W</span> <span class="o">=</span> <span class="n">power</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">dxW</span><span class="p">)</span>
        <span class="n">dI_E</span> <span class="o">=</span> <span class="n">power</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">dxE</span><span class="p">)</span>
        <span class="n">dI_N</span> <span class="o">=</span> <span class="n">power</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">dyN</span><span class="p">)</span>
        <span class="n">dI_S</span> <span class="o">=</span> <span class="n">power</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">dyS</span><span class="p">)</span>

        <span class="n">cW</span><span class="p">,</span> <span class="n">cE</span><span class="p">,</span> <span class="n">cN</span><span class="p">,</span> <span class="n">cS</span> <span class="o">=</span> <span class="n">_method</span><span class="p">(</span><span class="n">dI_W</span><span class="p">,</span> <span class="n">dI_E</span><span class="p">,</span> <span class="n">dI_N</span><span class="p">,</span> <span class="n">dI_S</span><span class="p">)</span>

        <span class="n">power</span> <span class="o">=</span> <span class="n">power</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="n">l</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span>
                <span class="n">cN</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">dI_N</span><span class="p">)</span>
                <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cS</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">dI_S</span><span class="p">))</span>
                <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cE</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">dI_E</span><span class="p">))</span>
                <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cW</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">dI_W</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># covnert natural to db units after filter is done</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">geeutils</span><span class="o">.</span><span class="n">power_to_db</span><span class="p">(</span><span class="n">power</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">img</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="hydrafloods.filtering.refined_lee">
<code class="codehilite language-python"><span class="n">refined_lee</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">keep_bands</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">])</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Refined Lee speckle filtering algorithm.
Algorithm adapted from https://groups.google.com/g/google-earth-engine-developers/c/ExepnAmP-hQ/m/7e5DnjXXAQAJ</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>image</code></td>
        <td><code>ee.Image</code></td>
        <td><p>Earth engine image object. Expects that imagery is a SAR image</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>ee.Image</code></td>
      <td><p>filtered SAR image using the Refined Lee algorithm</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>hydrafloods/filtering.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@decorators</span><span class="o">.</span><span class="n">keep_names</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">keep_attrs</span>
<span class="k">def</span> <span class="nf">refined_lee</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">keep_bands</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Refined Lee speckle filtering algorithm.</span>
<span class="sd">    Algorithm adapted from https://groups.google.com/g/google-earth-engine-developers/c/ExepnAmP-hQ/m/7e5DnjXXAQAJ</span>

<span class="sd">    args:</span>
<span class="sd">        image (ee.Image): Earth engine image object. Expects that imagery is a SAR image</span>

<span class="sd">    returns:</span>
<span class="sd">        ee.Image: filtered SAR image using the Refined Lee algorithm</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: include keep bands...maybe one-shot filtering if using keep_bands???</span>
    <span class="k">def</span> <span class="nf">apply_filter</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Closure function to apply the refined lee algorithm on individual bands&quot;&quot;&quot;</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">power</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

        <span class="c1"># img must be in natural units, i.e. not in dB!</span>
        <span class="c1"># Set up 3x3 kernels</span>
        <span class="n">weights3</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">kernel3</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Kernel</span><span class="o">.</span><span class="n">fixed</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">weights3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">mean3</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">reduceNeighborhood</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">kernel3</span><span class="p">)</span>
        <span class="n">variance3</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">reduceNeighborhood</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">variance</span><span class="p">(),</span> <span class="n">kernel3</span><span class="p">)</span>

        <span class="c1"># Use a sample of the 3x3 windows inside a 7x7 windows to determine gradients and directions</span>
        <span class="n">sample_weights</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">sample_kernel</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Kernel</span><span class="o">.</span><span class="n">fixed</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">sample_weights</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Calculate mean and variance for the sampled windows and store as 9 bands</span>
        <span class="n">sample_mean</span> <span class="o">=</span> <span class="n">mean3</span><span class="o">.</span><span class="n">neighborhoodToBands</span><span class="p">(</span><span class="n">sample_kernel</span><span class="p">)</span>
        <span class="n">sample_var</span> <span class="o">=</span> <span class="n">variance3</span><span class="o">.</span><span class="n">neighborhoodToBands</span><span class="p">(</span><span class="n">sample_kernel</span><span class="p">)</span>

        <span class="c1"># Determine the 4 gradients for the sampled windows</span>
        <span class="n">gradients</span> <span class="o">=</span> <span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
        <span class="n">gradients</span> <span class="o">=</span> <span class="n">gradients</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span>
            <span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">gradients</span> <span class="o">=</span> <span class="n">gradients</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span>
            <span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">gradients</span> <span class="o">=</span> <span class="n">gradients</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span>
            <span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># And find the maximum gradient amongst gradient bands</span>
        <span class="n">max_gradient</span> <span class="o">=</span> <span class="n">gradients</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

        <span class="c1"># Create a mask for band pixels that are the maximum gradient</span>
        <span class="n">gradmask</span> <span class="o">=</span> <span class="n">gradients</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">max_gradient</span><span class="p">)</span>

        <span class="c1"># duplicate gradmask bands: each gradient represents 2 directions</span>
        <span class="n">gradmask</span> <span class="o">=</span> <span class="n">gradmask</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">gradmask</span><span class="p">)</span>

        <span class="c1"># Determine the 8 directions</span>
        <span class="n">directions</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
            <span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">7</span><span class="p">)))</span>
            <span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">directions</span> <span class="o">=</span> <span class="n">directions</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span>
            <span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
            <span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
            <span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
            <span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">directions</span> <span class="o">=</span> <span class="n">directions</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span>
            <span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
            <span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">5</span><span class="p">)))</span>
            <span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">directions</span> <span class="o">=</span> <span class="n">directions</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span>
            <span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
            <span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">8</span><span class="p">)))</span>
            <span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># The next 4 are the not() of the previous 4</span>
        <span class="n">directions</span> <span class="o">=</span> <span class="n">directions</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">directions</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">Not</span><span class="p">()</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
        <span class="n">directions</span> <span class="o">=</span> <span class="n">directions</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">directions</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">Not</span><span class="p">()</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
        <span class="n">directions</span> <span class="o">=</span> <span class="n">directions</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">directions</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">Not</span><span class="p">()</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
        <span class="n">directions</span> <span class="o">=</span> <span class="n">directions</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">directions</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">Not</span><span class="p">()</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>

        <span class="c1"># Mask all values that are not 1-8</span>
        <span class="n">directions</span> <span class="o">=</span> <span class="n">directions</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">gradmask</span><span class="p">)</span>

        <span class="c1"># &quot;collapse&quot; the stack into a singe band image (due to masking, each pixel has just one value (1-8) in it&#39;s directional band, and is otherwise masked)</span>
        <span class="n">directions</span> <span class="o">=</span> <span class="n">directions</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

        <span class="n">sample_stats</span> <span class="o">=</span> <span class="n">sample_var</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">sample_mean</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">sample_mean</span><span class="p">))</span>

        <span class="c1"># Calculate localNoiseVariance</span>
        <span class="n">sigmaV</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">sample_stats</span><span class="o">.</span><span class="n">toArray</span><span class="p">()</span>
            <span class="o">.</span><span class="n">arraySort</span><span class="p">()</span>
            <span class="o">.</span><span class="n">arraySlice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="o">.</span><span class="n">arrayReduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="c1"># Set up the 7*7 kernels for directional statistics</span>
        <span class="n">rect_weights</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
            <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">diag_weights</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">rect_kernel</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Kernel</span><span class="o">.</span><span class="n">fixed</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">rect_weights</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">diag_kernel</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Kernel</span><span class="o">.</span><span class="n">fixed</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">diag_weights</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Create stacks for mean and variance using the original kernels. Mask with relevant direction.</span>
        <span class="n">dir_mean</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">reduceNeighborhood</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">rect_kernel</span><span class="p">)</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span>
            <span class="n">directions</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">dir_var</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">reduceNeighborhood</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">variance</span><span class="p">(),</span> <span class="n">rect_kernel</span><span class="p">)</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span>
            <span class="n">directions</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">dir_mean</span> <span class="o">=</span> <span class="n">dir_mean</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span>
            <span class="n">img</span><span class="o">.</span><span class="n">reduceNeighborhood</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">diag_kernel</span><span class="p">)</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span>
                <span class="n">directions</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">dir_var</span> <span class="o">=</span> <span class="n">dir_var</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span>
            <span class="n">img</span><span class="o">.</span><span class="n">reduceNeighborhood</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">variance</span><span class="p">(),</span> <span class="n">diag_kernel</span><span class="p">)</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span>
                <span class="n">directions</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># and add the bands for rotated kernels</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="n">dir_mean</span> <span class="o">=</span> <span class="n">dir_mean</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span>
                <span class="n">img</span><span class="o">.</span><span class="n">reduceNeighborhood</span><span class="p">(</span>
                    <span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">rect_kernel</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">directions</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="n">dir_var</span> <span class="o">=</span> <span class="n">dir_var</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span>
                <span class="n">img</span><span class="o">.</span><span class="n">reduceNeighborhood</span><span class="p">(</span>
                    <span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">variance</span><span class="p">(),</span> <span class="n">rect_kernel</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">directions</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="n">dir_mean</span> <span class="o">=</span> <span class="n">dir_mean</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span>
                <span class="n">img</span><span class="o">.</span><span class="n">reduceNeighborhood</span><span class="p">(</span>
                    <span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">diag_kernel</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">directions</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="n">dir_var</span> <span class="o">=</span> <span class="n">dir_var</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span>
                <span class="n">img</span><span class="o">.</span><span class="n">reduceNeighborhood</span><span class="p">(</span>
                    <span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">variance</span><span class="p">(),</span> <span class="n">diag_kernel</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">directions</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
            <span class="p">)</span>

        <span class="c1"># &quot;collapse&quot; the stack into a single band image (due to masking, each pixel has just one value in it&#39;s directional band, and is otherwise masked)</span>
        <span class="n">dir_mean</span> <span class="o">=</span> <span class="n">dir_mean</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">dir_var</span> <span class="o">=</span> <span class="n">dir_var</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

        <span class="c1"># A finally generate the filtered value</span>
        <span class="n">varX</span> <span class="o">=</span> <span class="n">dir_var</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">dir_mean</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">dir_mean</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">sigmaV</span><span class="p">))</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span>
            <span class="n">sigmaV</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">b</span> <span class="o">=</span> <span class="n">varX</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">dir_var</span><span class="p">)</span>

        <span class="c1"># return multi-band image band from array</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">dir_mean</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">dir_mean</span><span class="p">)))</span>
            <span class="o">.</span><span class="n">arrayProject</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
            <span class="o">.</span><span class="n">arrayFlatten</span><span class="p">([[</span><span class="s2">&quot;sum&quot;</span><span class="p">]])</span>
            <span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="n">band_names</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">keep_bands</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">keep_img</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">keep_bands</span><span class="p">)</span>
        <span class="n">proc_bands</span> <span class="o">=</span> <span class="n">band_names</span><span class="o">.</span><span class="n">removeAll</span><span class="p">(</span><span class="n">keep_bands</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">proc_bands</span> <span class="o">=</span> <span class="n">band_names</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">proc_bands</span><span class="p">)</span>

    <span class="n">power</span> <span class="o">=</span> <span class="n">geeutils</span><span class="o">.</span><span class="n">db_to_power</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">proc_bands</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">apply_filter</span><span class="p">))</span><span class="o">.</span><span class="n">toBands</span><span class="p">()</span>

    <span class="n">output</span> <span class="o">=</span> <span class="n">geeutils</span><span class="o">.</span><span class="n">power_to_db</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">result</span><span class="p">))</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">proc_bands</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">keep_bands</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">keep_img</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../floods/" class="md-footer__link md-footer__link--prev" aria-label="Previous: floods module" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              floods module
            </div>
          </div>
        </a>
      
      
        
        <a href="../fuzzy/" class="md-footer__link md-footer__link--next" aria-label="Next: fuzzy module" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              fuzzy module
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.5e67fbfe.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.c44cc438.min.js"></script>
      
    
  </body>
</html>