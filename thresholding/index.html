
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.8">
    
    
      
        <title>thresholding module - HYDRAFloods Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.644de097.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#hydrafloods.thresholding" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="HYDRAFloods Documentation" class="md-header__button md-logo" aria-label="HYDRAFloods Documentation" data-md-component="logo">
      
  <img src="../img/hydrafloods_logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            HYDRAFloods Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              thresholding module
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="HYDRAFloods Documentation" class="md-nav__button md-logo" aria-label="HYDRAFloods Documentation" data-md-component="logo">
      
  <img src="../img/hydrafloods_logo.png" alt="logo">

    </a>
    HYDRAFloods Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        Installation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../using-datasets/" class="md-nav__link">
        Using the Dataset class
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../algorithms/" class="md-nav__link">
        Algorithms
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../workflow-example/" class="md-nav__link">
        Workflow Example
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../cli/" class="md-nav__link">
        Command Line Interface
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_8">
          API Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="API Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          API Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../corrections/" class="md-nav__link">
        corrections module
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../datasets/" class="md-nav__link">
        datasets module
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../depths/" class="md-nav__link">
        depths module
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../decorators/" class="md-nav__link">
        decorators module
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../fetch/" class="md-nav__link">
        fetch module
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../floods/" class="md-nav__link">
        floods module
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../filtering/" class="md-nav__link">
        filtering module
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../fuzzy/" class="md-nav__link">
        fuzzy module
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../geeutils/" class="md-nav__link">
        geeutils module
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../indices/" class="md-nav__link">
        indices module
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ml/" class="md-nav__link">
        ml module
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          thresholding module
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        thresholding module
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#hydrafloods.thresholding" class="md-nav__link">
    thresholding
  </a>
  
    <nav class="md-nav" aria-label="thresholding">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hydrafloods.thresholding.bmax_otsu" class="md-nav__link">
    bmax_otsu()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hydrafloods.thresholding.edge_otsu" class="md-nav__link">
    edge_otsu()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hydrafloods.thresholding.fuzzy_otsu" class="md-nav__link">
    fuzzy_otsu()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hydrafloods.thresholding.kmeans_extent" class="md-nav__link">
    kmeans_extent()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hydrafloods.thresholding.modis_flood" class="md-nav__link">
    modis_flood()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hydrafloods.thresholding.multidim_semisupervised" class="md-nav__link">
    multidim_semisupervised()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hydrafloods.thresholding.otsu" class="md-nav__link">
    otsu()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../timeseries/" class="md-nav__link">
        timeseries module
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../utils/" class="md-nav__link">
        utils module
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../dswfp/" class="md-nav__link">
        workflows.dswfp module
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#hydrafloods.thresholding" class="md-nav__link">
    thresholding
  </a>
  
    <nav class="md-nav" aria-label="thresholding">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hydrafloods.thresholding.bmax_otsu" class="md-nav__link">
    bmax_otsu()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hydrafloods.thresholding.edge_otsu" class="md-nav__link">
    edge_otsu()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hydrafloods.thresholding.fuzzy_otsu" class="md-nav__link">
    fuzzy_otsu()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hydrafloods.thresholding.kmeans_extent" class="md-nav__link">
    kmeans_extent()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hydrafloods.thresholding.modis_flood" class="md-nav__link">
    modis_flood()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hydrafloods.thresholding.multidim_semisupervised" class="md-nav__link">
    multidim_semisupervised()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hydrafloods.thresholding.otsu" class="md-nav__link">
    otsu()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


  <h1>thresholding module</h1>

<div class="doc doc-object doc-module">



<h2 class="doc doc-heading" id="hydrafloods.thresholding">
        <code>hydrafloods.thresholding</code>



</h2>

    <div class="doc doc-contents first">




  <div class="doc doc-children">








  <div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="hydrafloods.thresholding.bmax_otsu">
<code class="codehilite language-python"><span class="n">bmax_otsu</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">initial_threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">thresh_no_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">grid_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">bmax_threshold</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">iters</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_boxes</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">max_buckets</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">min_bucket_width</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">max_raw</span><span class="o">=</span><span class="mf">1000000.0</span><span class="p">,</span> <span class="n">return_threshold</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Implementation of the B-Max Otsu thresholding algorithm.
Detailed explanation of algorithm can be found at https://doi.org/10.3390/rs12152469</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>img</code></td>
        <td><code>ee.Image</code></td>
        <td><p>input image to thresholding algorithm</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>band</code></td>
        <td><code>str | None,optional</code></td>
        <td><p>band name to use for thresholding, if set to <code>None</code> will use first band in image. default = None</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>region</code></td>
        <td><code>ee.Geometry | None</code></td>
        <td><p>region to determine threshold, if set to <code>None</code> will use img.geometry(). default = None</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>scale</code></td>
        <td><code>int</code></td>
        <td><p>scale at which to perform reduction operations, setting higher will prevent OOM errors. default = 90</p></td>
        <td><code>90</code></td>
      </tr>
      <tr>
        <td><code>initial_threshold</code></td>
        <td><code>float</code></td>
        <td><p>initial estimate of water/no-water for estimating the probabilities of classes in segment. default = 0</p></td>
        <td><code>0</code></td>
      </tr>
      <tr>
        <td><code>thresh_no_data</code></td>
        <td><code>float</code></td>
        <td><p>threshold to be used when histogram is empty (likely little to no water present in image). default = -0.2</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>invert</code></td>
        <td><code>bool</code></td>
        <td><p>boolean switch to determine if to threshold greater than (True) or less than (False). default = False</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>grid_size</code></td>
        <td><code>float</code></td>
        <td><p>size in decimal degrees to tile image/region to check for bimodality. default = 0.1</p></td>
        <td><code>0.1</code></td>
      </tr>
      <tr>
        <td><code>bmax_threshold</code></td>
        <td><code>float</code></td>
        <td><p>value 0-1 to determine if a value of bmax is bimodal or not. default = 0.75</p></td>
        <td><code>0.75</code></td>
      </tr>
      <tr>
        <td><code>iters</code></td>
        <td><code>int</code></td>
        <td><p>number of iterations to successively shrink the bmax tiles to refine threshold. 1 uses defined grid_size. default = 1</p></td>
        <td><code>1</code></td>
      </tr>
      <tr>
        <td><code>max_boxes</code></td>
        <td><code>int</code></td>
        <td><p>maximum number of tiles/boxes to use when determining threshold, will select based on maximum bmax ordering. default = None</p></td>
        <td><code>100</code></td>
      </tr>
      <tr>
        <td><code>seed</code></td>
        <td><code>int</code></td>
        <td><p>random number generator seed for randomly selected max_boxes. default = 7</p></td>
        <td><code>7</code></td>
      </tr>
      <tr>
        <td><code>max_buckets</code></td>
        <td><code>int</code></td>
        <td><p>The maximum number of buckets to use when building a histogram; will be rounded up to a power of 2. default = 255</p></td>
        <td><code>255</code></td>
      </tr>
      <tr>
        <td><code>min_bucket_width</code></td>
        <td><code>float</code></td>
        <td><p>The minimum histogram bucket width to allow any power of 2. default = 0.001</p></td>
        <td><code>0.001</code></td>
      </tr>
      <tr>
        <td><code>max_raw</code></td>
        <td><code>int</code></td>
        <td><p>The number of values to accumulate before building the initial histogram. default = 1e6</p></td>
        <td><code>1000000.0</code></td>
      </tr>
      <tr>
        <td><code>return_threshold</code></td>
        <td><code>bool</code></td>
        <td><p>boolean switch, if set to true then function will return threshold number, else thresholded image. default = False</p></td>
        <td><code>False</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>ee.Image</code></td>
      <td><p>thresholded image based (if return_threshold==False) or threshold value (if return_threshold==True) based on the threshold determined by the algorithm</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>hydrafloods/thresholding.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@decorators</span><span class="o">.</span><span class="n">keep_attrs</span>
<span class="k">def</span> <span class="nf">bmax_otsu</span><span class="p">(</span>
    <span class="n">img</span><span class="p">,</span>
    <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">region</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">scale</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
    <span class="n">initial_threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">thresh_no_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">grid_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">bmax_threshold</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
    <span class="n">iters</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">max_boxes</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
    <span class="n">max_buckets</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
    <span class="n">min_bucket_width</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
    <span class="n">max_raw</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span>
    <span class="n">return_threshold</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implementation of the B-Max Otsu thresholding algorithm.</span>
<span class="sd">    Detailed explanation of algorithm can be found at https://doi.org/10.3390/rs12152469</span>

<span class="sd">    args:</span>
<span class="sd">        img (ee.Image): input image to thresholding algorithm</span>
<span class="sd">        band (str | None,optional): band name to use for thresholding, if set to `None` will use first band in image. default = None</span>
<span class="sd">        region (ee.Geometry | None, optional): region to determine threshold, if set to `None` will use img.geometry(). default = None</span>
<span class="sd">        scale (int, optional): scale at which to perform reduction operations, setting higher will prevent OOM errors. default = 90</span>
<span class="sd">        initial_threshold (float, optional): initial estimate of water/no-water for estimating the probabilities of classes in segment. default = 0</span>
<span class="sd">        thresh_no_data (float, optional): threshold to be used when histogram is empty (likely little to no water present in image). default = -0.2</span>
<span class="sd">        invert (bool, optional): boolean switch to determine if to threshold greater than (True) or less than (False). default = False</span>
<span class="sd">        grid_size (float, optional): size in decimal degrees to tile image/region to check for bimodality. default = 0.1</span>
<span class="sd">        bmax_threshold (float, optional): value 0-1 to determine if a value of bmax is bimodal or not. default = 0.75</span>
<span class="sd">        iters (int, optional): number of iterations to successively shrink the bmax tiles to refine threshold. 1 uses defined grid_size. default = 1</span>
<span class="sd">        max_boxes (int, optional): maximum number of tiles/boxes to use when determining threshold, will select based on maximum bmax ordering. default = None</span>
<span class="sd">        seed (int, optional): random number generator seed for randomly selected max_boxes. default = 7</span>
<span class="sd">        max_buckets (int, optional): The maximum number of buckets to use when building a histogram; will be rounded up to a power of 2. default = 255</span>
<span class="sd">        min_bucket_width (float, optional): The minimum histogram bucket width to allow any power of 2. default = 0.001</span>
<span class="sd">        max_raw (int, optional): The number of values to accumulate before building the initial histogram. default = 1e6</span>
<span class="sd">        return_threshold (bool, optional): boolean switch, if set to true then function will return threshold number, else thresholded image. default = False</span>

<span class="sd">    returns:</span>
<span class="sd">        ee.Image: thresholded image based (if return_threshold==False) or threshold value (if return_threshold==True) based on the threshold determined by the algorithm</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">calcBmax</span><span class="p">(</span><span class="n">feature</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Closure function to calculate Bmax for each feature covering image&quot;&quot;&quot;</span>
        <span class="n">segment</span> <span class="o">=</span> <span class="n">img</span>
        <span class="n">initial</span> <span class="o">=</span> <span class="n">segment</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">initial_threshold</span><span class="p">)</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span>
            <span class="n">initial</span><span class="o">.</span><span class="n">reduceRegion</span><span class="p">(</span>
                <span class="n">reducer</span><span class="o">=</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                <span class="n">geometry</span><span class="o">=</span><span class="n">feature</span><span class="o">.</span><span class="n">geometry</span><span class="p">(),</span>
                <span class="n">bestEffort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">histBand</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Algorithms</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="mf">0.9999</span><span class="p">))</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>

        <span class="n">m</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">segment</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">initial</span><span class="p">)</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;m1&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">segment</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">initial</span><span class="o">.</span><span class="n">Not</span><span class="p">())</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;m2&quot;</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="n">mReduced</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">reduceRegion</span><span class="p">(</span>
            <span class="n">reducer</span><span class="o">=</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="n">geometry</span><span class="o">=</span><span class="n">feature</span><span class="o">.</span><span class="n">geometry</span><span class="p">(),</span>
            <span class="n">bestEffort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">m1</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">mReduced</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;m1&quot;</span><span class="p">))</span>
        <span class="n">m2</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">mReduced</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;m2&quot;</span><span class="p">))</span>

        <span class="n">m1</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Algorithms</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="o">-</span><span class="mi">25</span><span class="p">))</span>
        <span class="n">m2</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Algorithms</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">m2</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="n">sigmab</span> <span class="o">=</span> <span class="n">p1</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">m1</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">m2</span><span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
        <span class="n">sigmat</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span>
            <span class="n">segment</span><span class="o">.</span><span class="n">reduceRegion</span><span class="p">(</span>
                <span class="n">reducer</span><span class="o">=</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">variance</span><span class="p">(),</span>
                <span class="n">geometry</span><span class="o">=</span><span class="n">feature</span><span class="o">.</span><span class="n">geometry</span><span class="p">(),</span>
                <span class="n">bestEffort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">histBand</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">sigmat</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Algorithms</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">sigmat</span><span class="p">,</span> <span class="n">sigmat</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">bmax</span> <span class="o">=</span> <span class="n">sigmab</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">sigmat</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">feature</span><span class="o">.</span><span class="n">set</span><span class="p">({</span><span class="s2">&quot;bmax&quot;</span><span class="p">:</span> <span class="n">bmax</span><span class="p">})</span>

    <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">histBand</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">histBand</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">histBand</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">region</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">region</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span>

    <span class="n">grid</span> <span class="o">=</span> <span class="n">geeutils</span><span class="o">.</span><span class="n">tile_region</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">centroid_within</span><span class="o">=</span><span class="n">region</span><span class="p">,</span> <span class="n">grid_size</span><span class="o">=</span><span class="n">grid_size</span><span class="p">)</span>

    <span class="n">bmaxes</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">calcBmax</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="s2">&quot;bmax&quot;</span><span class="p">,</span> <span class="n">bmax_threshold</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">iters</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iters</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">grid_size</span> <span class="o">/=</span> <span class="mf">2.0</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="n">geeutils</span><span class="o">.</span><span class="n">tile_region</span><span class="p">(</span>
                <span class="n">bmaxes</span><span class="o">.</span><span class="n">geometry</span><span class="p">(),</span> <span class="n">centroid_within</span><span class="o">=</span><span class="n">bmaxes</span><span class="p">,</span> <span class="n">grid_size</span><span class="o">=</span><span class="n">grid_size</span>
            <span class="p">)</span>

            <span class="n">bmaxes</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">calcBmax</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="s2">&quot;bmax&quot;</span><span class="p">,</span> <span class="n">bmax_threshold</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">max_boxes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">bmaxes</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">max_boxes</span><span class="p">,</span> <span class="s2">&quot;bmax&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">bmaxes</span>

    <span class="n">histogram</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">reduceRegion</span><span class="p">(</span>
        <span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">max_buckets</span><span class="p">,</span> <span class="n">min_bucket_width</span><span class="p">,</span> <span class="n">max_raw</span><span class="p">)</span>
        <span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="s2">&quot;variance&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
        <span class="n">selection</span><span class="p">,</span>
        <span class="n">scale</span><span class="p">,</span>
        <span class="n">bestEffort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">tileScale</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">thresh_no_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span>
            <span class="n">ee</span><span class="o">.</span><span class="n">Algorithms</span><span class="o">.</span><span class="n">If</span><span class="p">(</span>
                <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span><span class="n">histogram</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">histBand</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_histogram&quot;</span><span class="p">)))</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span>
                    <span class="s2">&quot;bucketMeans&quot;</span>
                <span class="p">),</span>
                <span class="n">otsu</span><span class="p">(</span><span class="n">histogram</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">histBand</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_histogram&quot;</span><span class="p">))),</span>
                <span class="n">thresh_no_data</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">otsu</span><span class="p">(</span><span class="n">histogram</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">histBand</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_histogram&quot;</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">return_threshold</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">water</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Algorithms</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">invert</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">threshold</span><span class="p">),</span> <span class="n">img</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">threshold</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">water</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;water&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">uint8</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="hydrafloods.thresholding.edge_otsu">
<code class="codehilite language-python"><span class="n">edge_otsu</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">initial_threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">thresh_no_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">canny_threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">canny_sigma</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">canny_lt</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">connected_pixels</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">edge_length</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">edge_buffer</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_buckets</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">min_bucket_width</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">max_raw</span><span class="o">=</span><span class="mf">1000000.0</span><span class="p">,</span> <span class="n">return_threshold</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Implementation of the Edge Otsu thresholding algorithm.
Detailed explanation of algorithm can be found at https://doi.org/10.3390/rs12152469</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>img</code></td>
        <td><code>ee.Image</code></td>
        <td><p>input image to thresholding algorithm</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>band</code></td>
        <td><code>str | None,optional</code></td>
        <td><p>band name to use for thresholding, if set to <code>None</code> will use first band in image. default = None</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>region</code></td>
        <td><code>ee.Geometry | None</code></td>
        <td><p>region to determine threshold, if set to <code>None</code> will use img.geometry(). default = None</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>scale</code></td>
        <td><code>int</code></td>
        <td><p>scale at which to perform reduction operations, setting higher will prevent OOM errors. default = 90</p></td>
        <td><code>90</code></td>
      </tr>
      <tr>
        <td><code>initial_threshold</code></td>
        <td><code>float</code></td>
        <td><p>initial estimate of water/no-water for estimating the edges. default = 0</p></td>
        <td><code>0</code></td>
      </tr>
      <tr>
        <td><code>thresh_no_data</code></td>
        <td><code>float</code></td>
        <td><p>threshold to be used when histogram is empty (likely little to no water present in image). default = -0.2</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>invert</code></td>
        <td><code>bool</code></td>
        <td><p>boolean switch to determine if to threshold greater than (True) or less than (False). default = False</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>canny_threshold</code></td>
        <td><code>float</code></td>
        <td><p>threshold for canny edge detection. default = 0.05</p></td>
        <td><code>0.05</code></td>
      </tr>
      <tr>
        <td><code>canny_sigma</code></td>
        <td><code>float</code></td>
        <td><p>sigma value for gaussian filter in canny edge detection. default = 0</p></td>
        <td><code>0</code></td>
      </tr>
      <tr>
        <td><code>canny_lt</code></td>
        <td><code>float</code></td>
        <td><p>lower threshold for canny detection. default = 0.05</p></td>
        <td><code>0.05</code></td>
      </tr>
      <tr>
        <td><code>connected_pixels</code></td>
        <td><code>int</code></td>
        <td><p>maximum size of the neighborhood in pixels to determine if connected. default = 200</p></td>
        <td><code>200</code></td>
      </tr>
      <tr>
        <td><code>edge_length</code></td>
        <td><code>int</code></td>
        <td><p>minimum length of edges from canny detection to be considered edge. default = 50</p></td>
        <td><code>50</code></td>
      </tr>
      <tr>
        <td><code>edge_buffer</code></td>
        <td><code>int</code></td>
        <td><p>distance in meters to buffer edges on a side for histogram sampling. default = 100</p></td>
        <td><code>100</code></td>
      </tr>
      <tr>
        <td><code>max_buckets</code></td>
        <td><code>int</code></td>
        <td><p>The maximum number of buckets to use when building a histogram; will be rounded up to a power of 2. default = 255</p></td>
        <td><code>255</code></td>
      </tr>
      <tr>
        <td><code>min_bucket_width</code></td>
        <td><code>float</code></td>
        <td><p>The minimum histogram bucket width to allow any power of 2. default = 0.001</p></td>
        <td><code>0.001</code></td>
      </tr>
      <tr>
        <td><code>max_raw</code></td>
        <td><code>int</code></td>
        <td><p>The number of values to accumulate before building the initial histogram. default = 1e6</p></td>
        <td><code>1000000.0</code></td>
      </tr>
      <tr>
        <td><code>return_threshold</code></td>
        <td><code>bool</code></td>
        <td><p>boolean switch, if set to true then function will return threshold number, else thresholded image. default = False</p></td>
        <td><code>False</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>ee.Image</code></td>
      <td><p>thresholded image based (if return_threshold==False) or threshold value (if return_threshold==True) based on the threshold determined by the algorithm</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>hydrafloods/thresholding.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@decorators</span><span class="o">.</span><span class="n">keep_attrs</span>
<span class="k">def</span> <span class="nf">edge_otsu</span><span class="p">(</span>
    <span class="n">img</span><span class="p">,</span>
    <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">region</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">scale</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
    <span class="n">initial_threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">thresh_no_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">canny_threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
    <span class="n">canny_sigma</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">canny_lt</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
    <span class="n">connected_pixels</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
    <span class="n">edge_length</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">edge_buffer</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">max_buckets</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
    <span class="n">min_bucket_width</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
    <span class="n">max_raw</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span>
    <span class="n">return_threshold</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implementation of the Edge Otsu thresholding algorithm.</span>
<span class="sd">    Detailed explanation of algorithm can be found at https://doi.org/10.3390/rs12152469</span>

<span class="sd">    args:</span>
<span class="sd">        img (ee.Image): input image to thresholding algorithm</span>
<span class="sd">        band (str | None,optional): band name to use for thresholding, if set to `None` will use first band in image. default = None</span>
<span class="sd">        region (ee.Geometry | None, optional): region to determine threshold, if set to `None` will use img.geometry(). default = None</span>
<span class="sd">        scale (int, optional): scale at which to perform reduction operations, setting higher will prevent OOM errors. default = 90</span>
<span class="sd">        initial_threshold (float, optional): initial estimate of water/no-water for estimating the edges. default = 0</span>
<span class="sd">        thresh_no_data (float, optional): threshold to be used when histogram is empty (likely little to no water present in image). default = -0.2</span>
<span class="sd">        invert (bool, optional): boolean switch to determine if to threshold greater than (True) or less than (False). default = False</span>
<span class="sd">        canny_threshold (float, optional): threshold for canny edge detection. default = 0.05</span>
<span class="sd">        canny_sigma (float, optional): sigma value for gaussian filter in canny edge detection. default = 0</span>
<span class="sd">        canny_lt (float, optional): lower threshold for canny detection. default = 0.05</span>
<span class="sd">        connected_pixels (int, optional): maximum size of the neighborhood in pixels to determine if connected. default = 200</span>
<span class="sd">        edge_length (int, optional): minimum length of edges from canny detection to be considered edge. default = 50</span>
<span class="sd">        edge_buffer (int, optional): distance in meters to buffer edges on a side for histogram sampling. default = 100</span>
<span class="sd">        max_buckets (int, optional): The maximum number of buckets to use when building a histogram; will be rounded up to a power of 2. default = 255</span>
<span class="sd">        min_bucket_width (float, optional): The minimum histogram bucket width to allow any power of 2. default = 0.001</span>
<span class="sd">        max_raw (int, optional): The number of values to accumulate before building the initial histogram. default = 1e6</span>
<span class="sd">        return_threshold (bool, optional): boolean switch, if set to true then function will return threshold number, else thresholded image. default = False</span>

<span class="sd">    returns:</span>
<span class="sd">        ee.Image: thresholded image based (if return_threshold==False) or threshold value (if return_threshold==True) based on the threshold determined by the algorithm</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">histBand</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">histBand</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">histBand</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">region</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">region</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span>

    <span class="n">binary</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">initial_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;binary&quot;</span><span class="p">)</span>

    <span class="c1"># get canny edges</span>
    <span class="n">canny</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Algorithms</span><span class="o">.</span><span class="n">CannyEdgeDetector</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">canny_threshold</span><span class="p">,</span> <span class="n">canny_sigma</span><span class="p">)</span>
    <span class="c1"># process canny edges</span>
    <span class="n">connected</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">canny</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">canny</span><span class="p">)</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">canny_lt</span><span class="p">)</span><span class="o">.</span><span class="n">connectedPixelCount</span><span class="p">(</span><span class="n">connected_pixels</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="n">connected</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="n">edge_length</span><span class="p">)</span>
    <span class="n">edgeBuffer</span> <span class="o">=</span> <span class="n">edges</span><span class="o">.</span><span class="n">focal_max</span><span class="p">(</span><span class="n">edge_buffer</span><span class="p">,</span> <span class="s2">&quot;square&quot;</span><span class="p">,</span> <span class="s2">&quot;meters&quot;</span><span class="p">)</span>

    <span class="c1"># mask out areas to get histogram for Otsu</span>
    <span class="n">histogram_image</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">edgeBuffer</span><span class="p">)</span>

    <span class="n">histogram</span> <span class="o">=</span> <span class="n">histogram_image</span><span class="o">.</span><span class="n">reduceRegion</span><span class="p">(</span>
        <span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">max_buckets</span><span class="p">,</span> <span class="n">min_bucket_width</span><span class="p">,</span> <span class="n">max_raw</span><span class="p">)</span>
        <span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="s2">&quot;variance&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
        <span class="n">region</span><span class="p">,</span>
        <span class="n">scale</span><span class="p">,</span>
        <span class="n">bestEffort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">tileScale</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">thresh_no_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span>
            <span class="n">ee</span><span class="o">.</span><span class="n">Algorithms</span><span class="o">.</span><span class="n">If</span><span class="p">(</span>
                <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span><span class="n">histogram</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">histBand</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_histogram&quot;</span><span class="p">)))</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span>
                    <span class="s2">&quot;bucketMeans&quot;</span>
                <span class="p">),</span>
                <span class="n">otsu</span><span class="p">(</span><span class="n">histogram</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">histBand</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_histogram&quot;</span><span class="p">))),</span>
                <span class="n">thresh_no_data</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">otsu</span><span class="p">(</span><span class="n">histogram</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">histBand</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_histogram&quot;</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">return_threshold</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">threshold</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">water</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Algorithms</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">invert</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">threshold</span><span class="p">),</span> <span class="n">img</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">threshold</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">water</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;water&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">uint8</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="hydrafloods.thresholding.fuzzy_otsu">
<code class="codehilite language-python"><span class="n">fuzzy_otsu</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">initial_threshold</span><span class="o">=-</span><span class="mf">15.5</span><span class="p">,</span> <span class="n">grid_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">max_boxes</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_buckets</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">min_bucket_width</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">max_raw</span><span class="o">=</span><span class="mf">1000000.0</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Implementation of Otsu thresholding algorithm.
Segment the grids into water and land representation using initial threshold and randomly select features to calculate
minimum and maximum threshold of the image. Calculate Midpoint of min and max threshold using Fuzzy_Gaussian to map water.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>img</code></td>
        <td><code>ee.Image</code></td>
        <td><p>input image to thresholding algorithm</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>band</code></td>
        <td><code>str | None,optional</code></td>
        <td><p>band name to use for thresholding, if set to <code>None</code> will use first band in image. default = None</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>region</code></td>
        <td><code>ee.Geometry | None</code></td>
        <td><p>region to determine threshold, if set to <code>None</code> will use img.geometry(). default = None</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>scale</code></td>
        <td><code>int</code></td>
        <td><p>scale at which to perform reduction operations, setting higher will prevent OOM errors. default = 90</p></td>
        <td><code>90</code></td>
      </tr>
      <tr>
        <td><code>initial_threshold</code></td>
        <td><code>float</code></td>
        <td><p>initial estimate of water/no-water for estimating the probabilities of classes in segment. default = -15.5</p></td>
        <td><code>-15.5</code></td>
      </tr>
      <tr>
        <td><code>grid_size</code></td>
        <td><code>float</code></td>
        <td><p>size in decimal degrees to tile image/region to check for bimodality. default = 0.1</p></td>
        <td><code>0.1</code></td>
      </tr>
      <tr>
        <td><code>max_boxes</code></td>
        <td><code>int</code></td>
        <td><p>maximum number of tiles/boxes to use when determining threshold. default = 20</p></td>
        <td><code>20</code></td>
      </tr>
      <tr>
        <td><code>seed</code></td>
        <td><code>int</code></td>
        <td><p>random number generator seed for randomly selected max_boxes. default = 7</p></td>
        <td><code>0</code></td>
      </tr>
      <tr>
        <td><code>max_buckets</code></td>
        <td><code>int</code></td>
        <td><p>The maximum number of buckets to use when building a histogram; will be rounded up to a power of 2. default = 255</p></td>
        <td><code>255</code></td>
      </tr>
      <tr>
        <td><code>min_bucket_width</code></td>
        <td><code>float</code></td>
        <td><p>The minimum histogram bucket width to allow any power of 2. default = 0.001</p></td>
        <td><code>0.001</code></td>
      </tr>
      <tr>
        <td><code>max_raw</code></td>
        <td><code>int</code></td>
        <td><p>The number of values to accumulate before building the initial histogram. default = 1e6</p></td>
        <td><code>1000000.0</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>ee.Image</code></td>
      <td><p>thresholded water image.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>hydrafloods/thresholding.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@decorators</span><span class="o">.</span><span class="n">keep_attrs</span>
<span class="k">def</span> <span class="nf">fuzzy_otsu</span><span class="p">(</span>
    <span class="n">img</span><span class="p">,</span>
    <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">region</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">scale</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
    <span class="n">initial_threshold</span><span class="o">=-</span><span class="mf">15.5</span><span class="p">,</span>
    <span class="n">grid_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">max_boxes</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">max_buckets</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
    <span class="n">min_bucket_width</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
    <span class="n">max_raw</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implementation of Otsu thresholding algorithm.</span>
<span class="sd">    Segment the grids into water and land representation using initial threshold and randomly select features to calculate</span>
<span class="sd">    minimum and maximum threshold of the image. Calculate Midpoint of min and max threshold using Fuzzy_Gaussian to map water.</span>


<span class="sd">    args:</span>
<span class="sd">        img (ee.Image): input image to thresholding algorithm</span>
<span class="sd">        band (str | None,optional): band name to use for thresholding, if set to `None` will use first band in image. default = None</span>
<span class="sd">        region (ee.Geometry | None, optional): region to determine threshold, if set to `None` will use img.geometry(). default = None</span>
<span class="sd">        scale (int, optional): scale at which to perform reduction operations, setting higher will prevent OOM errors. default = 90</span>
<span class="sd">        initial_threshold (float, optional): initial estimate of water/no-water for estimating the probabilities of classes in segment. default = -15.5</span>
<span class="sd">        grid_size (float, optional): size in decimal degrees to tile image/region to check for bimodality. default = 0.1</span>
<span class="sd">        max_boxes (int, optional): maximum number of tiles/boxes to use when determining threshold. default = 20</span>
<span class="sd">        seed (int, optional): random number generator seed for randomly selected max_boxes. default = 7</span>
<span class="sd">        max_buckets (int, optional): The maximum number of buckets to use when building a histogram; will be rounded up to a power of 2. default = 255</span>
<span class="sd">        min_bucket_width (float, optional): The minimum histogram bucket width to allow any power of 2. default = 0.001</span>
<span class="sd">        max_raw (int, optional): The number of values to accumulate before building the initial histogram. default = 1e6</span>

<span class="sd">    returns:</span>
<span class="sd">        ee.Image: thresholded water image.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Function to Segment Land and Water Grids</span>
    <span class="k">def</span> <span class="nf">segment_grid</span><span class="p">(</span><span class="n">feature</span><span class="p">):</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">initImg</span><span class="o">.</span><span class="n">reduceRegion</span><span class="p">(</span>
            <span class="n">reducer</span><span class="o">=</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
            <span class="n">geometry</span><span class="o">=</span><span class="n">feature</span><span class="o">.</span><span class="n">geometry</span><span class="p">(),</span>
            <span class="n">bestEffort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">feature</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">region</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">region</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">histBand</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">histBand</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">histBand</span><span class="p">)</span>

    <span class="n">grid</span> <span class="o">=</span> <span class="n">geeutils</span><span class="o">.</span><span class="n">tile_region</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">intersect_geom</span><span class="o">=</span><span class="n">region</span><span class="p">,</span> <span class="n">grid_size</span><span class="o">=</span><span class="n">grid_size</span><span class="p">)</span>

    <span class="c1"># Prepare good representation of water and land</span>
    <span class="n">initWater</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">initial_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;water&quot;</span><span class="p">)</span>
    <span class="n">initImg</span> <span class="o">=</span> <span class="n">initWater</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">initWater</span><span class="o">.</span><span class="n">Not</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;land&quot;</span><span class="p">))</span>

    <span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">segment_grid</span><span class="p">)</span>

    <span class="c1"># Select water and land grid</span>
    <span class="n">selection</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="s2">&quot;water&quot;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="s2">&quot;land&quot;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))</span>
    <span class="p">)</span>

    <span class="c1"># Randomly select features</span>
    <span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">randomColumn</span><span class="p">(</span><span class="s2">&quot;random&quot;</span><span class="p">)</span>
    <span class="n">nBoxes</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
    <span class="n">randomSelection</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">max_boxes</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">nBoxes</span><span class="p">)</span>
    <span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="s2">&quot;random&quot;</span><span class="p">,</span> <span class="n">randomSelection</span><span class="p">))</span>

    <span class="c1"># Create histogram for selected features to calculate min threshold</span>
    <span class="n">histogram</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">reduceRegion</span><span class="p">(</span>
        <span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">max_buckets</span><span class="p">,</span> <span class="n">min_bucket_width</span><span class="p">,</span> <span class="n">max_raw</span><span class="p">)</span>
        <span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="s2">&quot;variance&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
        <span class="n">selection</span><span class="o">.</span><span class="n">geometry</span><span class="p">(),</span>
        <span class="n">scale</span><span class="p">,</span>
        <span class="n">bestEffort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">tileScale</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">min_threshold</span> <span class="o">=</span> <span class="n">otsu</span><span class="p">(</span><span class="n">histogram</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">histBand</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_histogram&quot;</span><span class="p">)))</span>

    <span class="c1"># Create histogram to calculate max threshold</span>
    <span class="n">histogram2</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">min_threshold</span><span class="p">))</span><span class="o">.</span><span class="n">reduceRegion</span><span class="p">(</span>
        <span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">max_buckets</span><span class="p">,</span> <span class="n">min_bucket_width</span><span class="p">,</span> <span class="n">max_raw</span><span class="p">)</span>
        <span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="s2">&quot;variance&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
        <span class="n">selection</span><span class="o">.</span><span class="n">geometry</span><span class="p">(),</span>
        <span class="n">scale</span><span class="p">,</span>
        <span class="n">bestEffort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">tileScale</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">max_threshold</span> <span class="o">=</span> <span class="n">otsu</span><span class="p">(</span><span class="n">histogram2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">histBand</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="s2">&quot;_histogram&quot;</span><span class="p">)))</span>

    <span class="c1"># Calculate Midpoint of min and max threshold using Fuzzy_Gaussian</span>
    <span class="n">midpoint</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">min_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">max_threshold</span><span class="p">)))</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span>
        <span class="mi">2</span>
    <span class="p">)</span>
    <span class="n">spread</span> <span class="o">=</span> <span class="mf">0.2</span>

    <span class="n">gauss</span> <span class="o">=</span> <span class="n">fuzzy</span><span class="o">.</span><span class="n">fuzzy_gaussian</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">midpoint</span><span class="p">,</span> <span class="n">spread</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>

    <span class="n">waterImg</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">midpoint</span><span class="p">)</span>

    <span class="n">waterImg</span> <span class="o">=</span> <span class="n">waterImg</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">waterImg</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">gauss</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">waterImg</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="hydrafloods.thresholding.kmeans_extent">
<code class="codehilite language-python"><span class="n">kmeans_extent</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">hand</span><span class="p">,</span> <span class="n">initial_threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Water thresholding methodology using image values and HAND.
Method from https://doi.org/10.1016/j.rse.2020.111732</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>img</code></td>
        <td><code>ee.Image</code></td>
        <td><p>input image to thresholding algorithm</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>hand</code></td>
        <td><code>ee.Image</code></td>
        <td><p>Height Above Nearest Drainage image used as axis in clustering</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>initial_threshold</code></td>
        <td><code>float</code></td>
        <td><p>initial estimate of water/no-water for stratified sampling. default = 0</p></td>
        <td><code>0</code></td>
      </tr>
      <tr>
        <td><code>region</code></td>
        <td><code>ee.Geometry | None</code></td>
        <td><p>region to sample values for KMeans clustering, if set to <code>None</code> will use img.geometry(). default = None</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>band</code></td>
        <td><code>str | None,optional</code></td>
        <td><p>band name to use for thresholding, if set to <code>None</code> will use first band in image. default = None</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>samples</code></td>
        <td><code>int</code></td>
        <td><p>number of stratified samples to gather for clustering from the initial water/no-water map. default=500</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>seed</code></td>
        <td><code>int</code></td>
        <td><p>random number generator seed for sampling. default = 7</p></td>
        <td><code>7</code></td>
      </tr>
      <tr>
        <td><code>scale</code></td>
        <td><code>int</code></td>
        <td><p>scale at which to perform reduction operations, setting higher will prevent OOM errors. default = 90</p></td>
        <td><code>90</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>ee.Image</code></td>
      <td><p>clustered image from KMeans clusterer. Classes assumed to be water/no-water</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>hydrafloods/thresholding.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">kmeans_extent</span><span class="p">(</span>
    <span class="n">img</span><span class="p">,</span>
    <span class="n">hand</span><span class="p">,</span>
    <span class="n">initial_threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">region</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">n_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
    <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">scale</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Water thresholding methodology using image values and HAND.</span>
<span class="sd">    Method from https://doi.org/10.1016/j.rse.2020.111732</span>

<span class="sd">    args:</span>
<span class="sd">        img (ee.Image): input image to thresholding algorithm</span>
<span class="sd">        hand (ee.Image): Height Above Nearest Drainage image used as axis in clustering</span>
<span class="sd">        initial_threshold (float, optional): initial estimate of water/no-water for stratified sampling. default = 0</span>
<span class="sd">        region (ee.Geometry | None, optional): region to sample values for KMeans clustering, if set to `None` will use img.geometry(). default = None</span>
<span class="sd">        band (str | None,optional): band name to use for thresholding, if set to `None` will use first band in image. default = None</span>
<span class="sd">        samples (int, optional): number of stratified samples to gather for clustering from the initial water/no-water map. default=500</span>
<span class="sd">        seed (int, optional): random number generator seed for sampling. default = 7</span>
<span class="sd">        scale (int, optional): scale at which to perform reduction operations, setting higher will prevent OOM errors. default = 90</span>

<span class="sd">    returns:</span>
<span class="sd">        ee.Image: clustered image from KMeans clusterer. Classes assumed to be water/no-water</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_cluster_center</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">band_arr</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">classes</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">region</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">region</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">band</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>

    <span class="n">hand_band</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">hand</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

    <span class="c1"># convert invert to a number 0 or 1 for ee server-side</span>
    <span class="n">invert</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">invert</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">hand</span><span class="o">.</span><span class="n">unmask</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

    <span class="n">strata</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">band</span><span class="p">)</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">initial_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;strata&quot;</span><span class="p">)</span>

    <span class="n">samples</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">addBands</span><span class="p">(</span><span class="n">strata</span><span class="p">)</span><span class="o">.</span><span class="n">stratifiedSample</span><span class="p">(</span>
        <span class="n">numPoints</span><span class="o">=</span><span class="n">n_samples</span><span class="p">,</span>
        <span class="n">classBand</span><span class="o">=</span><span class="s2">&quot;strata&quot;</span><span class="p">,</span>
        <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
        <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
        <span class="n">classValues</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">classPoints</span><span class="o">=</span><span class="p">[</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">],</span>
        <span class="n">tileScale</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
        <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">clusterer</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Clusterer</span><span class="o">.</span><span class="n">wekaKMeans</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="p">[</span><span class="n">band</span><span class="p">,</span> <span class="n">hand_band</span><span class="p">])</span>

    <span class="n">samples</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">cluster</span><span class="p">(</span><span class="n">clusterer</span><span class="p">,</span> <span class="s2">&quot;classes&quot;</span><span class="p">)</span>
    <span class="n">classes</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">aggregate_array</span><span class="p">(</span><span class="s2">&quot;classes&quot;</span><span class="p">)</span>
    <span class="n">unique</span> <span class="o">=</span> <span class="n">classes</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">classes</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Array</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span>
    <span class="n">band_arr</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Array</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">aggregate_array</span><span class="p">(</span><span class="n">band</span><span class="p">))</span>

    <span class="n">class_means</span> <span class="o">=</span> <span class="n">unique</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_cluster_center</span><span class="p">)</span>

    <span class="n">min_mean</span> <span class="o">=</span> <span class="n">class_means</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

    <span class="n">water_class</span> <span class="o">=</span> <span class="n">class_means</span><span class="o">.</span><span class="n">indexOf</span><span class="p">(</span><span class="n">min_mean</span><span class="p">)</span>

    <span class="n">water</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">cluster</span><span class="p">(</span><span class="n">clusterer</span><span class="p">)</span>

    <span class="n">water</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Algorithms</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">water_class</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">water</span><span class="o">.</span><span class="n">Not</span><span class="p">(),</span> <span class="n">water</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">water</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;water&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">uint8</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="hydrafloods.thresholding.modis_flood">
<code class="codehilite language-python"><span class="n">modis_flood</span><span class="p">(</span><span class="n">img</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Implementation of the NASA  MODIS Flood algorithm. Expects that imagery
has</p>
<p>https://cdn.earthdata.nasa.gov/conduit/upload/17162/MCDWD_UserGuide_RevB.pdf</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>img</code></td>
        <td><code>ee.Image</code></td>
        <td><p>image to apply algorithm to, should be either MODIS or VIIRS sensor data</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>ee.Image</code></td>
      <td><p>resulting water map</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>hydrafloods/thresholding.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="nd">@decorators</span><span class="o">.</span><span class="n">keep_attrs</span>
<span class="k">def</span> <span class="nf">modis_flood</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implementation of the NASA  MODIS Flood algorithm. Expects that imagery</span>
<span class="sd">    has</span>

<span class="sd">    https://cdn.earthdata.nasa.gov/conduit/upload/17162/MCDWD_UserGuide_RevB.pdf</span>

<span class="sd">    args:</span>
<span class="sd">        img (ee.Image): image to apply algorithm to, should be either MODIS or VIIRS sensor data</span>

<span class="sd">    returns:</span>
<span class="sd">        ee.Image: resulting water map</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># coefficients for the algorithm</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.0013500</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mf">0.10811</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mf">0.7</span>
    <span class="n">d</span> <span class="o">=</span> <span class="mf">0.2027</span>
    <span class="n">e</span> <span class="o">=</span> <span class="mf">0.06757</span>

    <span class="n">water</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">expression</span><span class="p">(</span><span class="s2">&quot;((nir+a)/(red+b) &lt; c) and (red &lt; d) and (swir2 &lt; e)&quot;</span><span class="p">,{</span>
        <span class="s2">&quot;red&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">),</span>
        <span class="s2">&quot;nir&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;nir&quot;</span><span class="p">),</span>
        <span class="s2">&quot;swir2&quot;</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;swir2&quot;</span><span class="p">),</span>
        <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span>
        <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="n">b</span><span class="p">,</span>
        <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span>
        <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="n">d</span><span class="p">,</span>
        <span class="s2">&quot;e&quot;</span><span class="p">:</span> <span class="n">e</span>
    <span class="p">})</span><span class="o">.</span><span class="n">uint8</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;water&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">water</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="hydrafloods.thresholding.multidim_semisupervised">
<code class="codehilite language-python"><span class="n">multidim_semisupervised</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">rank_band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ranking</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">proba_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Implementation of the Automatic water detection from
multidimensional hierarchical clustering algorithm.
Method details: https://doi.org/10.1016/j.rse.2020.112209
Note: this is a similar method, not exact from the paper</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>img</code></td>
        <td><code>ee.Image</code></td>
        <td><p>input image to thresholding algorithm</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>bands</code></td>
        <td><code>list | ee.List</code></td>
        <td><p>band names to use for the semi supervised classification</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>rank_band</code></td>
        <td><code>str</code></td>
        <td><p>band name used to rank which unserpervised class is water. If None then first band name in <code>bands</code> is used. default = None</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>ranking</code></td>
        <td><code>str</code></td>
        <td><p>method to rank the classes by <code>rank_band</code>. Options are 'min' or 'max'. If 'min', then the lowest class mean is considered water. default = 'min'</p></td>
        <td><code>&#39;min&#39;</code></td>
      </tr>
      <tr>
        <td><code>region</code></td>
        <td><code>ee.Geometry | None</code></td>
        <td><p>region to sample values for KMeans clustering, if set to <code>None</code> will use img.geometry(). default = None</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>samples</code></td>
        <td><code>int</code></td>
        <td><p>number of stratified samples to gather for clustering from the initial water/no-water map. default=500</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>seed</code></td>
        <td><code>int</code></td>
        <td><p>random number generator seed for sampling. default = 7</p></td>
        <td><code>7</code></td>
      </tr>
      <tr>
        <td><code>scale</code></td>
        <td><code>int</code></td>
        <td><p>scale at which to perform reduction operations, setting higher will prevent OOM errors. default = 90</p></td>
        <td><code>90</code></td>
      </tr>
      <tr>
        <td><code>proba_threshold</code></td>
        <td><code>float</code></td>
        <td><p>probability threshold to create a binary water mask, should be in range of 0-1. If None, then the probability values are returned. default = None</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>hydrafloods/thresholding.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">multidim_semisupervised</span><span class="p">(</span>
    <span class="n">img</span><span class="p">,</span>
    <span class="n">bands</span><span class="p">,</span>
    <span class="n">rank_band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ranking</span><span class="o">=</span><span class="s2">&quot;min&quot;</span><span class="p">,</span>
    <span class="n">region</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">n_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
    <span class="n">scale</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
    <span class="n">proba_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implementation of the Automatic water detection from</span>
<span class="sd">    multidimensional hierarchical clustering algorithm.</span>
<span class="sd">    Method details: https://doi.org/10.1016/j.rse.2020.112209</span>
<span class="sd">    Note: this is a similar method, not exact from the paper</span>

<span class="sd">    args:</span>
<span class="sd">        img (ee.Image): input image to thresholding algorithm</span>
<span class="sd">        bands (list | ee.List): band names to use for the semi supervised classification</span>
<span class="sd">        rank_band (str, optional): band name used to rank which unserpervised class is water. If None then first band name in `bands` is used. default = None</span>
<span class="sd">        ranking (str, optional): method to rank the classes by `rank_band`. Options are &#39;min&#39; or &#39;max&#39;. If &#39;min&#39;, then the lowest class mean is considered water. default = &#39;min&#39;</span>
<span class="sd">        region (ee.Geometry | None, optional): region to sample values for KMeans clustering, if set to `None` will use img.geometry(). default = None</span>
<span class="sd">        samples (int, optional): number of stratified samples to gather for clustering from the initial water/no-water map. default=500</span>
<span class="sd">        seed (int, optional): random number generator seed for sampling. default = 7</span>
<span class="sd">        scale (int, optional): scale at which to perform reduction operations, setting higher will prevent OOM errors. default = 90</span>
<span class="sd">        proba_threshold (float, optional): probability threshold to create a binary water mask, should be in range of 0-1. If None, then the probability values are returned. default = None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">region</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">region</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">bands</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bands</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">bandNames</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bands</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rank_band</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rank_band</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">bands</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

    <span class="n">samples</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
        <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
        <span class="n">numPixels</span><span class="o">=</span><span class="n">n_samples</span><span class="p">,</span>
        <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
        <span class="n">dropNulls</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">tileScale</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">classifier</span> <span class="o">=</span> <span class="n">ml</span><span class="o">.</span><span class="n">unsupervised_rf</span><span class="p">(</span>
        <span class="mi">100</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">bands</span><span class="p">,</span> <span class="n">rank_feature</span><span class="o">=</span><span class="n">rank_band</span><span class="p">,</span> <span class="n">ranking</span><span class="o">=</span><span class="n">ranking</span>
    <span class="p">)</span>

    <span class="n">probas</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span><span class="o">.</span><span class="n">classify</span><span class="p">(</span><span class="n">classifier</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">proba_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">probas</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;water_proba&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">probas</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">proba_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;water&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">uint8</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">output</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="hydrafloods.thresholding.otsu">
<code class="codehilite language-python"><span class="n">otsu</span><span class="p">(</span><span class="n">histogram</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Otsu's method threhsolding algorithm.
Computes single intensity threshold that separate histogram into two classes, foreground and background</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>histogram</code></td>
        <td><code>ee.Dictionary</code></td>
        <td><p>computed object from ee.Reducer.histogram with keys "histogram" and "bucketMeans"</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>ee.Number</code></td>
      <td><p>value of maximum inter-class intensity variance based on histogram</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>hydrafloods/thresholding.py</code></summary>
          <div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">otsu</span><span class="p">(</span><span class="n">histogram</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Otsu&#39;s method threhsolding algorithm.</span>
<span class="sd">    Computes single intensity threshold that separate histogram into two classes, foreground and background</span>

<span class="sd">    args:</span>
<span class="sd">        histogram (ee.Dictionary): computed object from ee.Reducer.histogram with keys &quot;histogram&quot; and &quot;bucketMeans&quot;</span>

<span class="sd">    returns:</span>
<span class="sd">        ee.Number: value of maximum inter-class intensity variance based on histogram</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Array</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span><span class="n">histogram</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;histogram&quot;</span><span class="p">))</span>
    <span class="n">means</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Array</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span><span class="n">histogram</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bucketMeans&quot;</span><span class="p">))</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">means</span><span class="o">.</span><span class="n">length</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">sums</span> <span class="o">=</span> <span class="n">means</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">sums</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
    <span class="c1"># Compute between sum of squares, where each mean partitions the data.</span>

    <span class="k">def</span> <span class="nf">bss_function</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
        <span class="n">aCounts</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">aCount</span> <span class="o">=</span> <span class="n">aCounts</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">aMeans</span> <span class="o">=</span> <span class="n">means</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">aMean</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">aMeans</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">aCounts</span><span class="p">)</span>
            <span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
            <span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">aCount</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">bCount</span> <span class="o">=</span> <span class="n">total</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">aCount</span><span class="p">)</span>
        <span class="n">bMean</span> <span class="o">=</span> <span class="n">sums</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">aCount</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">aMean</span><span class="p">))</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">bCount</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">aCount</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">aMean</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="n">bCount</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">bMean</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="p">)</span>

    <span class="n">bss</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">bss_function</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">means</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">bss</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../ml/" class="md-footer__link md-footer__link--prev" aria-label="Previous: ml module" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              ml module
            </div>
          </div>
        </a>
      
      
        
        <a href="../timeseries/" class="md-footer__link md-footer__link--next" aria-label="Next: timeseries module" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              timeseries module
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.5e67fbfe.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.c44cc438.min.js"></script>
      
    
  </body>
</html>